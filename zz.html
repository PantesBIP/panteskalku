<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Emas - Toko Mas Pantes BIP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Orbitron:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ffd700;
            --secondary: #1a1a2e;
            --accent: #00ffff;
            --text: #ffffff;
            --text-secondary: #cccccc;
            --bg: #0f0f1a;
            --card-bg: #1a1a2e;
            --table-bg: #16213e;
            --table-header: #0f3460;
            --table-row-odd: #1a1a2e;
            --table-row-even: #16213e;
            --highlight: rgba(255, 215, 0, 0.1);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            padding: 0 15px;
        }

        /* Header Styles */
        .gamer-header {
            background-color: var(--secondary);
            padding: 12px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .logo-icon {
            font-size: 1.5rem;
        }

        .logo span {
            color: var(--accent);
        }

        .gamer-nav {
            display: flex;
        }

        .gamer-nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
            margin: 0;
            padding: 0;
        }

        .gamer-nav a {
            color: var(--text);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .gamer-nav a:hover {
            color: var(--primary);
        }

        .mobile-menu-btn {
            display: none;
            font-size: 1.4rem;
            cursor: pointer;
            color: var(--text);
            background: none;
            border: none;
            padding: 5px;
        }

        /* Card Styles */
        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border: none;
            margin-bottom: 2rem;
            transition: transform 0.3s;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .card-header {
            background-color: var(--primary);
            color: var(--secondary);
            font-weight: 600;
            border-radius: 10px 10px 0 0 !important;
            font-family: 'Orbitron', sans-serif;
            text-align: center;
        }

        /* Button Styles */
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
            color: var(--secondary);
            font-weight: 600;
        }

        .btn-primary:hover {
            background-color: #e6c200;
            border-color: #e6c200;
            color: var(--secondary);
        }

        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529;
        }

        .btn-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: white;
        }

        /* Form Styles */
        .form-control, .form-select {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
        }

        .form-control:focus, .form-select:focus {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: var(--primary);
            box-shadow: 0 0 0 0.25rem rgba(212, 175, 55, 0.25);
            color: var(--text);
        }

        .input-group-text {
            background-color: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: var(--primary);
        }

        /* Detail Penjualan */
        .detailPenjualan {
            background-color: var(--table-row-odd);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .detailPenjualan.show {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        .detailPenjualan h5 {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 1rem;
            font-family: 'Orbitron', sans-serif;
        }

        .detailPenjualan ul {
            list-style-type: none;
            padding-left: 0;
        }

        .detailPenjualan li {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detailPenjualan li:last-child {
            border-bottom: none;
            font-weight: bold;
            color: var(--primary);
        }

        /* Total Penjualan */
        #totalPenjualan h3 {
            color: var(--primary);
            font-weight: 700;
            text-align: center;
            padding: 1rem;
            background-color: var(--card-bg);
            border-radius: 8px;
            font-family: 'Orbitron', sans-serif;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        /* Form Buttons */
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .delete-btn-container {
            display: none;
        }

        /* Select2 Customization */
        .select2-container--bootstrap-5 .select2-selection {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
            height: 45px;
            padding: 8px 12px;
            border-radius: 5px;
        }

        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
            color: var(--text);
            padding-left: 0;
            line-height: 28px;
        }

        .select2-container--bootstrap-5 .select2-dropdown {
            background-color: var(--card-bg);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 5px;
        }

        .select2-container--bootstrap-5 .select2-results__option {
            color: var(--text);
            padding: 8px 12px;
        }

        .select2-container--bootstrap-5 .select2-results__option--selected {
            background-color: rgba(255, 215, 0, 0.2);
            color: var(--primary);
        }

        .select2-container--bootstrap-5 .select2-results__option--highlighted {
            background-color: rgba(255, 215, 0, 0.3);
            color: var(--primary);
        }

        /* Floating Button */
        .floating-view-harga {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 99;
        }

        .btn-view-harga {
            background-color: var(--primary);
            color: var(--secondary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-view-harga:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .btn-view-harga i {
            font-size: 24px;
        }

        /* Footer */
        .gamer-footer {
            background-color: var(--secondary);
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }

        .social-links a {
            color: white;
            font-size: 1.2rem;
            margin: 0 10px;
            transition: color 0.3s;
        }

        .social-links a:hover {
            color: var(--primary);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Spinner */
        .spinner {
            display: none;
            margin: 20px auto;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        /* Modal Harga */
        .modal-harga {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }

        .modal-content-harga {
            background-color: var(--card-bg);
            margin: 2% auto;
            padding: 25px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            width: 90%;
            max-width: 1000px;
            border-radius: 10px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.4);
            animation: fadeIn 0.3s;
        }

        .close-harga {
            color: var(--text-secondary);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-harga:hover {
            color: var(--primary);
        }

        .table-harga {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table-harga th {
            background-color: var(--primary);
            color: var(--secondary);
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .table-harga td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table-harga tr:nth-child(even) {
            background-color: var(--table-row-even);
        }

        .table-harga tr:hover {
            background-color: var(--highlight);
        }

        .harga-highlight {
            font-weight: bold;
            color: var(--primary);
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .gamer-nav {
                position: fixed;
                top: 60px;
                left: -100%;
                width: 80%;
                height: calc(100vh - 60px);
                background-color: var(--secondary);
                flex-direction: column;
                padding: 20px;
                transition: left 0.3s;
                box-shadow: 5px 0 15px rgba(0,0,0,0.2);
            }

            .gamer-nav.active {
                left: 0;
            }

            .gamer-nav ul {
                flex-direction: column;
                gap: 15px;
            }

            .mobile-menu-btn {
                display: block;
            }

            .form-buttons {
                justify-content: center;
            }

            .btn {
                flex: 1;
                min-width: 120px;
            }

            .col-form-label {
                text-align: left !important;
                padding-bottom: 5px;
            }

            .modal-content-harga {
                width: 95%;
                margin: 5% auto;
                padding: 15px;
            }
        }

        @media (max-width: 576px) {
            .logo {
                font-size: 1rem;
            }

            .card-header h3 {
                font-size: 1.2rem;
            }

            .form-buttons .btn {
                min-width: 100%;
                margin-bottom: 5px;
            }

            .modal-content-harga {
                width: 98%;
                margin: 2% auto;
                padding: 10px;
            }

            .table-harga th, 
            .table-harga td {
                padding: 8px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <header class="gamer-header">
        <div class="container">
            <div class="header-container">
                <div class="logo">
                    <span class="logo-icon"><i class="fas fa-coins"></i></span>
                    <h1>PantesBIP<span> Harga</span></h1>
                </div>
                
                <nav class="gamer-nav">
                    <ul>
                        <li><a href="#"><i class="fas fa-home"></i> Home</a></li>
                        <li><a href="#"><i class="fas fa-chart-line"></i> Trend</a></li>
                        <li><a href="#"><i class="fas fa-book"></i> Panduan</a></li>
                        <li><a href="#"><i class="fas fa-info-circle"></i> Tentang</a></li>
                    </ul>
                </nav>
                
                <button class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header text-center">
                        <h3><i class="fas fa-calculator me-2"></i> Kerja Kerja Kerja</h3>
                        <p class="mb-1">No Rek: BCA: 3747-7721-11 | Mandiri: 1340-5000-8111-1</p>
                        <p class="mb-1">A/n Markus W</p>
                        <p class="mb-0">Untuk Barang Amero dengan kode tertentu Lebih baik tanya lagi admin</p>
                    </div>
                    <div class="card-body">
                        <div id="formContainer">
                            <form id="formEmas" class="penjualan-form">
                                <div class="row mb-3">
                                    <label for="kategoriEmas" class="col-sm-3 col-form-label">Kategori Emas</label>
                                    <div class="col-sm-9">
                                        <select class="form-select kategoriEmas" required>
                                            <option value="" selected disabled>Pilih Kategori</option>
                                            <option value="event">EVENT ITALY</option>
                                            <option value="muda">Muda (38-54)</option>
                                            <option value="tua">Tua (75-92)</option>
                                            <option value="semua">Semua Kategori</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label for="kodeEmas" class="col-sm-3 col-form-label">Kode Emas</label>
                                    <div class="col-sm-9">
                                        <select class="form-select kodeEmas select2" required>
                                            <option value="" selected disabled>Pilih Kode Emas</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label for="hargaEmas" class="col-sm-3 col-form-label">Harga per gram</label>
                                    <div class="col-sm-9">
                                        <div class="input-group">
                                            <span class="input-group-text">Rp</span>
                                            <input type="text" class="form-control hargaEmas" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label for="ongkos" class="col-sm-3 col-form-label">Ongkos</label>
                                    <div class="col-sm-9">
                                        <select class="form-select ongkos" required>
                                            <option value="0">Tidak ada ongkos</option>
                                            <option value="15000">15 ribu x graman</option>
                                            <option value="5">5% x harga bulat</option>
                                            <option value="10">10% x harga bulat</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label for="beratEmas" class="col-sm-3 col-form-label">Berat Emas</label>
                                    <div class="col-sm-9">
                                        <div class="input-group">
                                            <input type="number" class="form-control beratEmas" required step="0.01" min="0.01">
                                            <span class="input-group-text">gram</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label for="discount" class="col-sm-3 col-form-label">Discount</label>
                                    <div class="col-sm-9">
                                        <div class="input-group">
                                            <span class="input-group-text">Rp</span>
                                            <input type="number" class="form-control discount" value="0" min="0">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-buttons">
                                    <button type="button" class="btn btn-primary hitungBtn">
                                        <i class="fas fa-calculator me-1"></i> Hitung
                                    </button>
                                    <button type="reset" class="btn btn-danger clearBtn">
                                        <i class="fas fa-eraser me-1"></i> Reset
                                    </button>
                                    <div class="delete-btn-container">
                                        <button type="button" class="btn btn-warning deleteBtn">
                                            <i class="fas fa-trash me-1"></i> Hapus
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-info toggle-detail-btn mt-2">
                                    <i class="fas fa-eye me-1"></i> Tampilkan Detail
                                </button>
                            </form>
                        </div>

                        <button type="button" class="btn btn-success mt-3 tambahBarangBtn w-100">
                            <i class="fas fa-plus-circle me-1"></i> Tambah Barang
                        </button>

                        <div id="detailPenjualan" class="mt-4"></div>
                        <div id="totalPenjualan" class="mt-4"></div>
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal untuk menampilkan tabel harga -->
    <div id="hargaModal" class="modal-harga">
        <div class="modal-content-harga">
            <span class="close-harga">&times;</span>
            <h3><i class="fas fa-table me-2"></i> Daftar Harga Emas</h3>
            
            <div class="search-container mb-3">
                <input type="text" id="hargaSearch" class="form-control" placeholder="Cari kode atau keterangan...">
            </div>
            
            <div id="loadingHarga" class="spinner"></div>
            <div id="hargaTableContainer"></div>
            
            <div class="modal-footer-harga mt-3">
                <div class="info-text">
                    <i class="fas fa-info-circle me-1"></i> Harga terakhir diperbarui: <span id="lastUpdated"></span>
                </div>
                <button type="button" class="btn btn-primary btn-sm" id="refreshHargaBtn">
                    <i class="fas fa-sync-alt me-1"></i> Refresh Harga
                </button>
            </div>
        </div>
    </div>

    <div class="floating-view-harga">
        <button class="btn btn-view-harga" id="viewHargaBtn">
            <i class="fas fa-table"></i>
            <span class="d-none d-md-inline"> View Harga</span>
        </button>
    </div>

    <footer class="gamer-footer text-center">
        <div class="container">
            <div class="mb-3">
                <a href="https://www.instagram.com/tokomaspantes_bandung/" class="me-3"><i class="fab fa-instagram fa-lg"></i></a>
                <a href="https://api.whatsapp.com/send/?phone=%2B6289656737562&text&type=phone_number&app_absent=0"><i class="fab fa-whatsapp fa-lg"></i></a>
            </div>
            <p>&copy; 2024 Toko Mas Pantes BIP. All rights reserved.</p>
            <p class="text-muted">Created with <i class="fas fa-heart text-danger"></i> by kc</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // Variabel global
        let hargaEmas = {};
        let totalPenjualan = 0;
        let cokim = 1000000; // Default value, akan diupdate dari JSON

        // Data kode emas berdasarkan kategori
        const kodeEmasOptions = {
            muda: [
                {value: "38 Juene", text: "7K Juene"},
                {value: "44 Kuning", text: "8K Kuning "},
                {value: "44 Kuningcoll", text: "8K Kuning Collection"},
                {value: "46 Putih", text: "8K Putih "},
                {value: "48 Kuning", text: "9K Kuning "},
                {value: "48 Kuningcoll", text: "9K Kuning Collection "},
                {value: "49 Putih", text: "9K Putih "},
                {value: "46.5 8K", text: "8K BG (46.5)"},
                {value: "54 VC ILY", text: "Voila & ILY 9K"}
            ],
            tua: [
                {value: "75 16K", text: "16K Kuning"},
                {value: "75 16Kwg", text: "16K BG & HALA"},
                {value: "81-89 17K", text: "17K Putih / Amero 85"},
                {value: "81-89 17Kyg", text: "17K Kuning "},
                {value: "16K coll", text: "16K LPM"},
                {value: "17K coll", text: "18K LPM, Hala"},
                {value: "Italy", text: "Italy"},
                {value: "SDW", text: "SDW / LPM (92)"}
            ],
            event: [
                {value: "84.5", text: "84.5% Italy"},
                {value: "85.5", text: "85.5% Italy"},
                {value: "86.5", text: "86.5% Italy"},
                {value: "87.5", text: "87.5% Italy"},
                {value: "88.5", text: "88.5% Italy"},
                {value: "89.5", text: "89.5% Italy"},
                {value: "90.5", text: "90.5% Italy"}
            ],
            semua: [
                {value: "38 Juene", text: "7K Juene "},
                {value: "44 Kuning", text: "8K Kuning "},
                {value: "44 Kuningcoll", text: "8K Kuning Collection"},
                {value: "46 Putih", text: "8K Putih"},
                {value: "48 Kuning", text: "9K Kuning "},
                {value: "48 Kuningcoll", text: "9K Kuning Collection"},
                {value: "49 Putih", text: "9K Putih "},
                {value: "46.5 8K", text: "8K BG "},
                {value: "54 VC ILY", text: " Voila & ILY 9K"},
                {value: "75 16K", text: "16K Kuning"},
                {value: "75 16Kwg", text: "16K BG & HALA"},
                {value: "81-89 17K", text: "17K Putih / Amero "},
                {value: "81-89 17Kyg", text: "17K Kuning "},
                {value: "16K coll", text: "16K LPM"},
                {value: "17K coll", text: "18K LPM, Hala"},
                {value: "Italy", text: "Italy"},
                {value: "SDW", text: "SDW / LPM (92)"},
                {value: "84.5", text: "84.5% Italy"},
                {value: "85.5", text: "85.5% Italy"},
                {value: "86.5", text: "86.5% Italy"},
                {value: "87.5", text: "87.5% Italy"},
                {value: "88.5", text: "88.5% Italy"},
                {value: "89.5", text: "89.5% Italy"},
                {value: "90.5", text: "90.5% Italy"}
            ]
        };

        // Fungsi untuk menghitung harga khusus (84.5% - 90.5%) dengan pembulatan sesuai aturan
        function hitungHargaKhusus(kode) {
            const persentase = parseFloat(kode) / 100;
            let hargaDasar = cokim * persentase;
            
            // Bulatkan ke 500 atau 1000
            let remainder = hargaDasar % 1000;
            if (remainder >= 1 && remainder <= 499) {
                hargaDasar = hargaDasar - remainder + 500;
            } else if (remainder >= 501 && remainder <= 999) {
                hargaDasar = hargaDasar - remainder + 1000;
            }
            
            // Tambahkan 5%
            let hargaPlus5 = hargaDasar * 1.05;
            
            // Bulatkan lagi
            remainder = hargaPlus5 % 1000;
            if (remainder >= 1 && remainder <= 499) {
                hargaPlus5 = hargaPlus5 - remainder + 500;
            } else if (remainder >= 501 && remainder <= 999) {
                hargaPlus5 = hargaPlus5 - remainder + 1000;
            }
            
            return Math.round(hargaPlus5);
        }

        // Fungsi untuk memuat harga dari JSON
        async function loadHargaEmas() {
            try {
                const response = await fetch('harga_harian.json');
                if (!response.ok) throw new Error('Gagal memuat data harga');
                const data = await response.json();
                hargaEmas = data.hargaEmas;
                cokim = hargaEmas.cokim || 1000000; // Ambil nilai cokim dari JSON atau gunakan default
                
                console.log('Data harga berhasil dimuat');
                
                // Update last updated time
                const now = new Date();
                $('#lastUpdated').text(now.toLocaleString('id-ID'));
                
                // Hitung harga untuk kode 84.5 hingga 90.5 dengan logika baru
                const kodeKhusus = ["84.5", "85.5", "86.5", "87.5", "88.5", "89.5", "90.5"];
                kodeKhusus.forEach(kode => {
                    hargaEmas[kode] = hitungHargaKhusus(kode);
                });
                
                // Inisialisasi form pertama
                if ($('#formEmas').length) {
                    initializeFormElements($('#formEmas'));
                }
            } catch (error) {
                console.error('Error:', error);
                // Fallback data jika file JSON tidak ada
                hargaEmas = {
                    "38 Juene": 0,
                    "44 Kuning": 0,
                    "44 Kuningcoll": 0,
                    "46 Putih": 0,
                    "48 Kuning": 0,
                    "48 Kuningcoll": 0,
                    "49 Putih": 0,
                    "75 16K": 0,
                    "75 16Kwg": 0,
                    "81-89 17K": 0,
                    "81-89 17Kyg": 0,
                    "46.5 8K": 0,
                    "54 VC ILY": 0,
                    "16K coll": 0,
                    "17K coll": 0,
                    "Italy": 0,
                    "SDW": 0,
                    "84.5": 0,
                    "85.5": 0,
                    "86.5": 0,
                    "87.5": 0,
                    "88.5": 0,
                    "89.5": 0,
                    "90.5": 0,
                    "cokim": 0
                };
                
                // Update last updated time with fallback
                const now = new Date();
                $('#lastUpdated').text(now.toLocaleString('id-ID') + ' (data offline)');
                
                // Hitung harga untuk kode 84.5 hingga 90.5 dengan logika baru (fallback)
                const kodeKhusus = ["84.5", "85.5", "86.5", "87.5", "88.5", "89.5", "90.5"];
                kodeKhusus.forEach(kode => {
                    hargaEmas[kode] = hitungHargaKhusus(kode);
                });
                
                alert('Gagal memuat data harga terbaru. Menggunakan harga default.');
            }
        }

        // Initialize Select2 and other elements
        function initializeFormElements(form) {
            form.find('.select2').select2({
                placeholder: "Pilih Kode Emas",
                allowClear: true,
                width: '100%',
                dropdownParent: form.closest('#formContainer'),
                theme: 'bootstrap-5'
            });
            
            // Auto-fill harga when kode is selected
            form.find('.kodeEmas').on('change', function() {
                const kode = $(this).val();
                form.find('.hargaEmas').val(hargaEmas[kode] ? hargaEmas[kode].toLocaleString('id-ID') : '');
            });
            
            // Update kode emas options when kategori changes
            form.find('.kategoriEmas').on('change', function() {
                const kategori = $(this).val();
                updateKodeEmasOptions(form, kategori);
            });
            
            // Toggle detail button
            form.find('.toggle-detail-btn').off('click').on('click', function() {
                const detailContainer = form.next('.detailPenjualan');
                const isVisible = detailContainer.hasClass('show');
                
                if (isVisible) {
                    detailContainer.removeClass('show');
                    $(this).html('<i class="fas fa-eye me-1"></i> Tampilkan Detail');
                } else {
                    detailContainer.addClass('show');
                    $(this).html('<i class="fas fa-eye-slash me-1"></i> Sembunyikan Detail');
                }
            });
            
            // Hitung button
            form.find('.hitungBtn').off('click').on('click', function() {
                hitungHarga(form);
            });
        }

        // Fungsi untuk mengupdate pilihan kode emas berdasarkan kategori
        function updateKodeEmasOptions(form, kategori) {
            const kodeEmasSelect = form.find('.kodeEmas');
            const selectedValue = kodeEmasSelect.val();
            
            kodeEmasSelect.empty().append('<option value="" selected disabled>Pilih Kode Emas</option>');
            
            kodeEmasOptions[kategori].forEach(option => {
                kodeEmasSelect.append(`<option value="${option.value}">${option.text}</option>`);
            });
            
            // Reinitialize Select2
            kodeEmasSelect.select2('destroy');
            initializeFormElements(form);
            
            // Reset harga
            form.find('.hargaEmas').val('');
        }

        // Fungsi untuk menghitung harga
        function hitungHarga(form) {
            const kode = form.find('.kodeEmas').val();
            const berat = parseFloat(form.find('.beratEmas').val());
            const ongkosType = form.find('.ongkos').val();
            const discount = parseFloat(form.find('.discount').val()) || 0;

            if (!kode || isNaN(berat) || berat <= 0) {
                alert("Harap pilih kode emas dan isi berat dengan benar.");
                return;
            }

            const harga = hargaEmas[kode];
            const isKodeKhusus = ["84.5", "85.5", "86.5", "87.5", "88.5", "89.5", "90.5"].includes(kode);
            
            let hasilAwal, hasilBulat;
            
            if (isKodeKhusus) {
                // Untuk kode khusus, harga sudah termasuk 5% dan sudah dibulatkan
                hasilAwal = harga * berat;
                hasilBulat = hasilAwal; // Tidak perlu pembulatan lagi karena sudah dibulatkan di hitungHargaKhusus()
            } else {
                // Untuk kode biasa
                hasilAwal = harga * berat;
                
                // Bulatkan hasil awal
                let remainder = hasilAwal % 1000;
                if (remainder >= 1 && remainder <= 499) {
                    hasilBulat = hasilAwal - remainder + 500;
                } else if (remainder >= 501 && remainder <= 999) {
                    hasilBulat = hasilAwal - remainder + 1000;
                } else {
                    hasilBulat = hasilAwal;
                }
            }

            // Hitung ongkos
            let ongkos = 0;
            if (ongkosType === "15000") {
                ongkos = berat < 1 ? 15000 : 15000 * berat;
            } else if (ongkosType === "5") {
                ongkos = hasilBulat * 0.05;
            } else if (ongkosType === "10") {
                ongkos = hasilBulat * 0.10;
            }

            // Bulatkan ongkos
            let remainder = ongkos % 1000;
            if (remainder >= 1 && remainder <= 499) {
                ongkos = ongkos - remainder + 500;
            } else if (remainder >= 501 && remainder <= 999) {
                ongkos = ongkos - remainder + 1000;
            }

            // Hitung harga sebelum discount
            let hargaSebelumDiscount = hasilBulat + ongkos;

            // Bulatkan harga sebelum discount
            remainder = hargaSebelumDiscount % 1000;
            if (remainder >= 1 && remainder <= 499) {
                hargaSebelumDiscount = hargaSebelumDiscount - remainder + 500;
            } else if (remainder >= 501 && remainder <= 999) {
                hargaSebelumDiscount = hargaSebelumDiscount - remainder + 1000;
            }

            // Hitung harga setelah discount
            let hargaFix = hargaSebelumDiscount - discount;
            
            // Pastikan harga tidak negatif
            if (hargaFix < 0) {
                hargaFix = 0;
            }

            // Update total penjualan
            const previousHargaFix = form.data('hargaFix') || 0;
            totalPenjualan = totalPenjualan - previousHargaFix + hargaFix;
            updateTotalPenjualan(totalPenjualan);

            // Simpan hargaFix ke form
            form.data('hargaFix', hargaFix);

            // Tampilkan detail
            updateDetailPenjualan(form, kode, berat, harga, hasilAwal, hasilBulat, 0, 0, 0, ongkos, hargaSebelumDiscount, discount, hargaFix);
        }

        function updateTotalPenjualan(newTotal) {
            totalPenjualan = newTotal;
            $('#totalPenjualan').html(`<h3>Total Penjualan: Rp. ${totalPenjualan.toLocaleString('id-ID')}</h3>`);
        }

        function updateDetailPenjualan(form, kode, berat, harga, hasilAwal, hasilBulat, tambahan5Persen, tambahan10Persen, potonganAwal, ongkos, hargaSebelumDiscount, discount, hargaFix) {
            const isKodeKhusus = ["84.5", "85.5", "86.5", "87.5", "88.5", "89.5", "90.5"].includes(kode);
            
            // Hitung langkah-langkah khusus untuk ditampilkan
            let detailPerhitungan = '';
            let hargaDasarBulat = 0;
            let hargaPlus5 = 0;
            let hargaFinalBulat = 0;
            
            if (isKodeKhusus) {
                const persentase = parseFloat(kode) / 100;
                const hargaDasar = cokim * persentase;
                const remainder1 = hargaDasar % 1000;
                hargaDasarBulat = remainder1 >= 1 && remainder1 <= 499 ? 
                    hargaDasar - remainder1 + 500 : 
                    remainder1 >= 501 && remainder1 <= 999 ? 
                    hargaDasar - remainder1 + 1000 : 
                    hargaDasar;
                hargaPlus5 = hargaDasarBulat * 1.05;
                const remainder2 = hargaPlus5 % 1000;
                hargaFinalBulat = remainder2 >= 1 && remainder2 <= 499 ? 
                    hargaPlus5 - remainder2 + 500 : 
                    remainder2 >= 501 && remainder2 <= 999 ? 
                    hargaPlus5 - remainder2 + 1000 : 
                    hargaPlus5;
                
                detailPerhitungan = `
                    <p><strong>Detail Perhitungan Khusus:</strong></p>
                    <ol>
                        <li>COKIM × ${kode}% = ${cokim.toLocaleString('id-ID')} × ${kode}% = Rp. ${hargaDasar.toLocaleString('id-ID')}</li>
                        <li>Pembulatan pertama: Rp. ${hargaDasarBulat.toLocaleString('id-ID')}</li>
                        <li>Tambahkan 5%: Rp. ${hargaDasarBulat.toLocaleString('id-ID')} × 1.05 = Rp. ${hargaPlus5.toLocaleString('id-ID')}</li>
                        <li>Pembulatan akhir: Rp. ${Math.round(hargaFinalBulat).toLocaleString('id-ID')}</li>
                    </ol>
                `;
            }
            
            const detailHtml = `
                <div class="detailPenjualan show">
                    <h5><i class="fas fa-info-circle me-2"></i>Detail Perhitungan</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Kode:</strong> ${kode}${isKodeKhusus ? '%' : ''}</p>
                            <p><strong>Berat:</strong> ${berat} gram</p>
                            ${isKodeKhusus ? detailPerhitungan : ''}
                            <p><strong>Harga per gram:</strong> Rp. ${harga.toLocaleString('id-ID')}</p>
                        </div>
                        <div class="col-md-6">
                            <ul>
                                <li>Harga Awal (Harga x Berat) : Rp. ${(harga * berat).toLocaleString('id-ID')}</li>
                                <li>Harga Bulat: Rp. ${hasilBulat.toLocaleString('id-ID')}</li>
                                ${ongkos > 0 ? `<li>Ongkos: Rp. ${ongkos.toLocaleString('id-ID')}</li>` : ''}
                                <li>Harga Sebelum Discount: Rp. ${hargaSebelumDiscount.toLocaleString('id-ID')}</li>
                                ${discount > 0 ? `<li>Discount: Rp. ${discount.toLocaleString('id-ID')}</li>` : ''}
                                <li class="fw-bold">Harga Final: Rp. ${hargaFix.toLocaleString('id-ID')}</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            form.next('.detailPenjualan').remove();
            form.after(detailHtml);
            
            form.find('.toggle-detail-btn').html('<i class="fas fa-eye-slash me-1"></i> Sembunyikan Detail');
        }

        function clearTotalPenjualan() {
            totalPenjualan = 0;
            $('#totalPenjualan').html('');
            $('.detailPenjualan').remove();
        }

        // Fungsi untuk memuat tabel harga dengan fitur pencarian
        function loadHargaTable() {
            const container = $('#hargaTableContainer');
            const loading = $('#loadingHarga');
            
            container.empty();
            loading.show();
            
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table-harga" id="hargaTable">
                        <thead>
                            <tr>
                                <th>Keterangan</th>
                                <th>Harga</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Tambahkan data harga ke tabel
            Object.keys(hargaEmas).forEach(kode => {
                if (kode === "cokim") return; // Skip cokim
                
                // Cari keterangan dari kodeEmasOptions
                let keterangan = '';
                Object.keys(kodeEmasOptions).forEach(kategori => {
                    kodeEmasOptions[kategori].forEach(item => {
                        if (item.value === kode) {
                            keterangan = item.text;
                        }
                    });
                });
                
                tableHtml += `
                    <tr>
                        <td>${keterangan || '-'}</td>
                        <td class="harga-highlight">Rp. ${hargaEmas[kode].toLocaleString('id-ID')}</td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.html(tableHtml);
            loading.hide();
            
            // Inisialisasi pencarian
            $('#hargaSearch').on('keyup', function() {
                const value = $(this).val().toLowerCase();
                $("#hargaTable tbody tr").filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
        }
                
        // Event listener untuk document ready
        $(document).ready(function() {
            // Mobile menu toggle
            $('.mobile-menu-btn').on('click', function() {
                $('.gamer-nav').toggleClass('active');
            });

            // Close menu when clicking outside
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.gamer-nav').length && !$(e.target).closest('.mobile-menu-btn').length) {
                    $('.gamer-nav').removeClass('active');
                }
            });

            // Load harga emas saat pertama kali
            loadHargaEmas();
            
            // Show loading spinner temporarily (demo purposes)
            $('.spinner').show();
            setTimeout(function() {
                $('.spinner').hide();
            }, 1000);
            
            // Modal harga
            const modal = document.getElementById("hargaModal");
            const btn = document.getElementById("viewHargaBtn");
            const span = document.getElementsByClassName("close-harga")[0];
            
            btn.onclick = function() {
                modal.style.display = "block";
                loadHargaTable();
                $('#hargaSearch').focus();
            }
            
            span.onclick = function() {
                modal.style.display = "none";
            }
            
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
            
            // Refresh harga button
            $('#refreshHargaBtn').on('click', function() {
                loadHargaEmas().then(() => {
                    loadHargaTable();
                    alert('Data harga berhasil diperbarui!');
                }).catch(error => {
                    console.error('Error:', error);
                    alert('Gagal memuat data harga terbaru. Menggunakan data yang ada.');
                });
            });
            
            // Tambah barang button
            $('.tambahBarangBtn').on('click', function() {
                const formClone = $('#formEmas').clone();
                formClone.find('input, select').val('');
                formClone.find('.discount').val('0');
                formClone.removeAttr('id');
                formClone.find('.select2').removeClass('select2-hidden-accessible');
                formClone.find('.select2-container').remove();
                formClone.find('.delete-btn-container').css('display', 'block');
                formClone.find('.detailPenjualan').remove();
                $('#formContainer').append(formClone);
                
                // Initialize Select2 for the new form
                initializeFormElements(formClone);
                
                // Scroll to the new form
                $('html, body').animate({
                    scrollTop: formClone.offset().top - 100
                }, 500);
            });
            
            // Clear button
            $(document).on('click', '.clearBtn', function() {
                const form = $(this).closest('.penjualan-form');
                const previousHargaFix = form.data('hargaFix') || 0;
                totalPenjualan -= previousHargaFix;
                updateTotalPenjualan(totalPenjualan);
                
                form.removeData('hargaFix');
                form.next('.detailPenjualan').remove();
                
                // Reinitialize Select2 after clear
                form.find('.select2').select2('destroy');
                initializeFormElements(form);
                
                // Reset toggle button
                form.find('.toggle-detail-btn').html('<i class="fas fa-eye me-1"></i> Tampilkan Detail');
            });
            
            // Delete button
            $(document).on('click', '.deleteBtn', function() {
                const form = $(this).closest('.penjualan-form');
                const previousHargaFix = form.data('hargaFix') || 0;
                totalPenjualan -= previousHargaFix;
                updateTotalPenjualan(totalPenjualan);
                
                form.next('.detailPenjualan').remove();
                form.remove();
            });
        });
    </script>
</body>
</html>
