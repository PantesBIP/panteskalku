<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Powered By - Toko Mas Pantes BIP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #d4af37;
            --secondary-color: #343a40;
            --accent-color: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .navbar {
            background-color: var(--secondary-color) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
            font-size: 1.5rem;
        }

        .nav-link {
            color: white !important;
            transition: all 0.3s;
        }

        .nav-link:hover {
            color: var(--primary-color) !important;
            transform: translateY(-2px);
        }

        .container {
            max-width: 1200px;
        }

        .card {
            border-radius: 10px;
            box-shadow:  0 4px 20px rgba(0,0,0,0.08);
            border: none;
            margin-bottom: 2rem;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            border-radius: 10px 10px 0 0 !important;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #c9a227;
            border-color: #c9a227;
        }

        .btn-success {
            background-color: #28a745;
        }

        .btn-danger {
            background-color: #dc3545;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(212, 175, 55, 0.25);
        }

        footer {
            background-color: var(--secondary-color);
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .delete-btn-container {
            display: none;
        }

        .detailPenjualan {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            margin-top: 1rem;
            display: none;
        }

        .detailPenjualan.show {
            display: block;
        }

        .detailPenjualan h5 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .detailPenjualan ul {
            list-style-type: none;
            padding-left: 0;
        }

        .detailPenjualan li {
            padding: 0.3rem 0;
            border-bottom: 1px solid #eee;
        }

        .detailPenjualan li:last-child {
            border-bottom: none;
            font-weight: bold;
            color: var(--primary-color);
        }

        #totalPenjualan h3 {
            color: var(--primary-color);
            font-weight: 700;
            text-align: center;
            padding: 1rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
        }

        .tambahBarangBtn {
            width: 100%;
            padding: 10px;
            font-weight: 600;
        }

        .toggle-detail-btn {
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .col-form-label {
                text-align: left !important;
                padding-bottom: 0;
            }
            
            .form-buttons {
                justify-content: center;
            }
            
            .btn {
                flex: 1;
                min-width: 120px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .penjualan-form {
            animation: fadeIn 0.5s ease-out;
        }

        .spinner {
            display: none;
            margin: 20px auto;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Floating button styles */
        .floating-cokim {
            position: fixed;
            bottom: 90px;
            right: 20px;
            z-index: 99;
        }

        /* Floating buttons container */
.floating-buttons-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 99;
    display: flex;
    flex-direction: column-reverse;
    gap: 10px;
    align-items: flex-end;
}

.floating-btn-wrapper {
    transition: all 0.3s ease;
}

/* Base button styles for both buttons */
.btn-harga, .btn-cokim {
    color: white;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    transition: all 0.3s ease;
    border-radius: 50%;
    width: 50px;
    height: 50px;
}

.btn-harga {
    background-color: #28a745;
}

.btn-cokim {
    background-color: var(--primary-color);
}

.btn-harga:hover, .btn-cokim:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 15px rgba(0,0,0,0.4);
}

.btn-harga i, .btn-cokim i {
    font-size: 20px;
}

.btn-harga .text, .btn-cokim .text {
    display: none;
}

/* Desktop styles */
@media (min-width: 768px) {
    .btn-harga, .btn-cokim {
        width: auto;
        height: auto;
        padding: 10px 15px;
        border-radius: 30px;
    }
    
    .btn-harga i, .btn-cokim i {
        margin-right: 8px;
        font-size: 16px;
        }
        
        .btn-harga .text, .btn-cokim .text {
            display: inline;
            font-size: 14px;
        }
        
        .floating-buttons-container {
            gap: 15px;
        }
    }

    /* Animation when scrolling */
    @media (max-width: 767px) {
        .floating-buttons-container {
            bottom: 15px;
            right: 15px;
        }
        
        .btn-harga, .btn-cokim {
            width: 45px;
            height: 45px;
        }
        
        .btn-harga i, .btn-cokim i {
            font-size: 18px;
        }
    }

        .btn-cokim {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-cokim:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }

        .btn-cokim i {
            font-size: 24px;
        }

        .btn-cokim .text {
            display: none;
        }

        @media (min-width: 768px) {
            .btn-cokim {
                width: auto;
                height: auto;
                padding: 12px 20px;
                border-radius: 30px;
            }
            
            .btn-cokim i {
                margin-right: 8px;
            }
            
            .btn-cokim .text {
                display: inline;
            }
        }
        
        /* Item type selector */
        .item-type-selector {
            margin-bottom: 15px;
        }
        
        .item-type-selector select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ced4da;
        }

        /* Item selector */
        .item-selector {
            margin-bottom: 15px;
        }
        
        .item-selector select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ced4da;
        }

        /* Custom code input */
        .custom-code-input {
            display: none;
        }

        /* Table styles */
        .harga-table {
            width: 100%;
            border-collapse: collapse;
        }

        .harga-table th, .harga-table td {
            padding: 8px 12px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .harga-table th {
            background-color: var(--primary-color);
            color: white;
        }

        .harga-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .harga-table tr:hover {
            background-color: #e9e9e9;
        }

        .harga-category {
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-weight: bold;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-gem me-2"></i>Toko Mas Pantes BIP
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="https://pntsharga.netlify.app/trend">
                            <i class="fas fa-globe me-1"></i> Trend emas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://pntsharga.netlify.app">
                            <i class="fas fa-calculator me-1"></i> HARGA UPDATE
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header text-center">
                        <h3>No Rek</h3>
                        <label>|| BCA: 3747-7721-11</label> <label> || Mandiri : 1340-5000-8111-1 ||</label>
                        <p>A/n Markus W</p>
                        <label>Untuk Barang Amero dengan kode tertentu Naik satu barcode contoh 84.5 jadi 85.5</label>
                        <label>JUENE = 39, BG 8K = 46, ILY = 54, VOILA = 55, 16K BG & Hala = 77, 17K Biasa & Amero = 85, 
                                16K LPM = 80, 18 K LPM = 88, SDWLPM-92 = barcode x cokim
                        </label>
                    </div>
                    <div class="card-body">
                        <div id="formContainer">
                            <form id="formEmas" class="penjualan-form">
                                <div class="row mb-3">
                                    <label for="itemType" class="col-sm-3 col-form-label">Jenis Item</label>
                                    <div class="col-sm-9">
                                        <select class="form-select item-type" required>
                                            <option value="">-- Pilih Jenis Item --</option>
                                            <option value="fixed">Harga Tetap</option>
                                            <option value="kode">Kode Persentase</option>
                                            <option value="custom">Kode Custom</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- Di bagian form HTML -->
                                <div class="item-selector fixed-price-items" style="display: none;">
                                    <select class="form-select fixed-price-select">
                                        <option value="">-- Pilih Item Harga Tetap --</option>
                                        <!-- Options akan diisi oleh JavaScript -->
                                    </select>
                                </div>
                                
                                <div class="item-selector kode-items" style="display: none;">
                                    <select class="form-select kode-select">
                                        <option value="">-- Pilih Kode Item --</option>
                                        <!-- Options akan diisi oleh JavaScript -->
                                    </select>
                                </div>
                                
                                <!-- Custom code input -->
                                <div class="row mb-3 custom-code-input">
                                    <label for="kodeEmas" class="col-sm-3 col-form-label">Kode Emas</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control kodeEmas" placeholder="Masukkan kode emas (contoh: 84.5, 85.5, 90.5)">
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <label for="hargaEmas" class="col-sm-3 col-form-label">Harga per gram</label>
                                    <div class="col-sm-9">
                                        <div class="input-group">
                                            <span class="input-group-text">Rp</span>
                                            <input type="text" class="form-control hargaEmas" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label for="ongkos" class="col-sm-3 col-form-label">Ongkos</label>
                                    <div class="col-sm-9">
                                        <select class="form-select ongkos" required>
                                            <option value="0">Tidak ada ongkos</option>
                                            <option value="15000">15 ribu x graman</option>
                                            <option value="5">5% x harga bulat</option>
                                            <option value="10">10% x harga bulat</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label for="beratEmas" class="col-sm-3 col-form-label">Berat Emas</label>
                                    <div class="col-sm-9">
                                        <div class="input-group">
                                            <input type="number" class="form-control beratEmas" required step="0.01" min="0.01">
                                            <span class="input-group-text">gram</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label for="discount" class="col-sm-3 col-form-label">Discount</label>
                                    <div class="col-sm-9">
                                        <div class="input-group">
                                            <span class="input-group-text">Rp</span>
                                            <input type="number" class="form-control discount" value="0" min="0">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-buttons">
                                    <button type="button" class="btn btn-primary hitungBtn">
                                        <i class="fas fa-calculator me-1"></i> Hitung
                                    </button>
                                    <button type="reset" class="btn btn-danger clearBtn">
                                        <i class="fas fa-eraser me-1"></i> Reset
                                    </button>
                                    <div class="delete-btn-container">
                                        <button type="button" class="btn btn-warning deleteBtn">
                                            <i class="fas fa-trash me-1"></i> Hapus
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-info toggle-detail-btn">
                                    <i class="fas fa-eye me-1"></i> Tampilkan Detail
                                </button>
                            </form>
                        </div>

                        <button type="button" class="btn btn-success mt-3 tambahBarangBtn">
                            <i class="fas fa-plus-circle me-1"></i> Tambah Barang
                        </button>

                        <div id="detailPenjualan" class="mt-4"></div>
                        <div id="totalPenjualan" class="mt-4"></div>
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
       <!-- Floating Harga -->
    <div class="floating-harga" style="position: fixed; bottom: 160px; right: 20px; z-index: 99;">
        <button class="btn btn-harga" id="hargaBtn" title="Lihat Harga Emas">
            <i class="fas fa-table"></i>
            <span class="text">Harga</span>
        </button>
    </div>
    
    <!-- Add this modal at the bottom of your body, before the scripts -->
    <div class="modal fade" id="hargaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Daftar Harga Emas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="spinner text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div id="hargaContainer"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating button for COKIM input -->
    <div class="floating-cokim">
        <button class="btn btn-cokim" id="cokimBtn" title="Set COKIM Value">
            <i class="fas fa-coins"></i>
            <span class="text">COKIM</span>
        </button>
    </div>

    <footer class="text-center">
        <div class="container">
            <div class="mb-3">
                <a href="https://www.instagram.com/tokomaspantes_bandung/" class="text-white me-3"><i class="fab fa-instagram fa-lg"></i></a>
                <a href="https://api.whatsapp.com/send/?phone=%2B6289656737562&text&type=phone_number&app_absent=0" class="text-white"><i class="fab fa-whatsapp fa-lg"></i></a>
            </div>
            <p>&copy; 2024 Toko Mas. All rights reserved.</p>
            <p class="text-muted">Created with <i class="fas fa-heart text-danger"></i> by kc</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
// Variabel global
let cokim = 1743000;
let totalPenjualan = 0;
let fixedPriceItems = {};
let kodeItems = {};

// Fungsi untuk memuat data dari JSON
function loadData() {
    return $.ajax({
        url: 'data.json',
        dataType: 'json',
        success: function(data) {
            fixedPriceItems = {};
            kodeItems = {};
            
            // Konversi array ke object untuk fixedPriceItems
            data.fixedPriceItems.forEach(item => {
                fixedPriceItems[item.value] = item.label;
            });
            
            // Konversi array ke object untuk kodeItems
            data.kodeItems.forEach(item => {
                kodeItems[item.value] = item.label;
            });
            
            // Isi dropdown fixed price
            const fixedPriceSelect = $('.fixed-price-select');
            fixedPriceSelect.empty().append('<option value="">-- Pilih Item Harga Tetap --</option>');
            data.fixedPriceItems.forEach(item => {
                fixedPriceSelect.append(`<option value="${item.value}">${item.label}</option>`);
            });
            
            // Isi dropdown kode items
            const kodeSelect = $('.kode-select');
            kodeSelect.empty().append('<option value="">-- Pilih Kode Item --</option>');
            data.kodeItems.forEach(item => {
                kodeSelect.append(`<option value="${item.value}">${item.label}</option>`);
            });
        },
        error: function() {
            console.error('Gagal memuat data harga dan kode');
        }
    });
}

// Pada document ready
$(document).ready(function() {
    // Load data pertama kali
    loadData().then(function() {
        // Inisialisasi form setelah data dimuat
        initializeFormElements($('#formEmas'));
    });
    
    // ... kode lainnya tetap sama ...
});

// Fungsi untuk mengupdate harga per gram
function updateHargaPerGram(form) {
    const itemType = form.find('.item-type').val();
    const fixedPrice = form.find('.fixed-price-select').val();
    const kode = form.find('.kode-select').val();
    const customKode = form.find('.kodeEmas').val();
    
    if (itemType === 'fixed') {
        if (fixedPrice) {
            form.find('.hargaEmas').val(parseInt(fixedPrice).toLocaleString('id-ID'));
        } else {
            form.find('.hargaEmas').val('');
        }
    } 
    else if (itemType === 'kode') {
        if (kode) {
            const harga = hitungHargaKhusus(kode);
            if (harga !== null) {
                form.find('.hargaEmas').val(harga.toLocaleString('id-ID'));
            } else {
                form.find('.hargaEmas').val('');
            }
        } else {
            form.find('.hargaEmas').val('');
        }
    }
    else if (itemType === 'custom') {
        if (customKode) {
            const harga = hitungHargaKhusus(customKode);
            if (harga !== null) {
                form.find('.hargaEmas').val(harga.toLocaleString('id-ID'));
            } else {
                form.find('.hargaEmas').val('');
            }
        } else {
            form.find('.hargaEmas').val('');
        }
    }
    else {
        form.find('.hargaEmas').val('');
    }
}

function updateTotalPenjualan(newTotal) {
    totalPenjualan = newTotal;
    $('#totalPenjualan').html(`<h3>Total Penjualan: Rp. ${totalPenjualan.toLocaleString('id-ID')}</h3>`);
}

function updateDetailPenjualan(form, itemName, berat, harga, hasilAwal, hasilBulat, ongkos, hargaSebelumDiscount, discount, hargaFix) {
    let detailHtml = '';
    
    // Cek apakah ini item dengan harga tetap
    if (fixedPriceItems.hasOwnProperty(harga.toString())) {
        // Fixed price item
        detailHtml = `
            <div class="detailPenjualan show">
                <h5><i class="fas fa-info-circle me-2"></i>Detail Perhitungan (Harga Tetap)</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Item:</strong> ${itemName}</p>
                        <p><strong>Berat:</strong> ${berat} gram</p>
                    </div>
                    <div class="col-md-6">
                        <ul>
                            <li>Harga per gram: Rp. ${harga.toLocaleString('id-ID')}</li>
                            <li>Harga Awal (Harga x Berat): Rp. ${(harga * berat).toLocaleString('id-ID')}</li>
                            <li>Harga Bulat: Rp. ${hasilBulat.toLocaleString('id-ID')}</li>
                            ${ongkos > 0 ? `<li>Ongkos: Rp. ${ongkos.toLocaleString('id-ID')}</li>` : ''}
                            <li>Harga Sebelum Discount: Rp. ${hargaSebelumDiscount.toLocaleString('id-ID')}</li>
                            ${discount > 0 ? `<li>Discount: Rp. ${discount.toLocaleString('id-ID')}</li>` : ''}
                            <li class="fw-bold">Harga Final: Rp. ${hargaFix.toLocaleString('id-ID')}</li>
                        </ul>
                    </div>
                </div>
            </div>
        `;
    } else {
        // Item dengan kode (percentage-based)
        const persentase = itemName.includes('Kode:') ? 
            itemName.split(':')[1].trim().replace('%', '') : 
            itemName.match(/\d+/)[0];
        
        const persentaseDecimal = parseFloat(persentase) / 100;
        const hargaDasar = cokim * persentaseDecimal;
        
        // Proses pembulatan
        let remainder = hargaDasar % 1000;
        let hargaDasarBulat = remainder >= 1 && remainder <= 499 ? 
            hargaDasar - remainder + 500 : 
            remainder >= 501 && remainder <= 999 ? 
            hargaDasar - remainder + 1000 : 
            hargaDasar;
        
        detailHtml = `
            <div class="detailPenjualan show">
                <h5><i class="fas fa-info-circle me-2"></i>Detail Perhitungan</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Item:</strong> ${itemName}</p>
                        <p><strong>Berat:</strong> ${berat} gram</p>
                        <p><strong>COKIM:</strong> Rp. ${cokim.toLocaleString('id-ID')}</p>
                        <p><strong>Detail Perhitungan:</strong></p>
                        <ol>
                            <li>COKIM × ${persentase}% = ${cokim.toLocaleString('id-ID')} × ${persentase}% = Rp. ${hargaDasar.toLocaleString('id-ID')}</li>
                            <li>Pembulatan: Rp. ${hargaDasarBulat.toLocaleString('id-ID')}</li>
                        </ol>
                    </div>
                    <div class="col-md-6">
                        <ul>
                            <li>Harga per gram: Rp. ${harga.toLocaleString('id-ID')}</li>
                            <li>Harga Awal (Harga x Berat): Rp. ${(harga * berat).toLocaleString('id-ID')}</li>
                            <li>Harga Bulat: Rp. ${hasilBulat.toLocaleString('id-ID')}</li>
                            ${ongkos > 0 ? `<li>Ongkos: Rp. ${ongkos.toLocaleString('id-ID')}</li>` : ''}
                            <li>Harga Sebelum Discount: Rp. ${hargaSebelumDiscount.toLocaleString('id-ID')}</li>
                            ${discount > 0 ? `<li>Discount: Rp. ${discount.toLocaleString('id-ID')}</li>` : ''}
                            <li class="fw-bold">Harga Final: Rp. ${hargaFix.toLocaleString('id-ID')}</li>
                        </ul>
                    </div>
                </div>
            </div>
        `;
    }
    
    form.next('.detailPenjualan').remove();
    form.after(detailHtml);
    
    form.find('.toggle-detail-btn').html('<i class="fas fa-eye-slash me-1"></i> Sembunyikan Detail');
}

function hitungHargaKhusus(kode) {
    // Parse the kode (could be a percentage like "39" or a decimal like "84.5")
    const persentase = parseFloat(kode);
    if (isNaN(persentase)) return null;
    
    // Calculate base price
    const hargaDasar = cokim * (persentase / 100);
    
    // Round to nearest 500
    let remainder = hargaDasar % 1000;
    if (remainder >= 1 && remainder <= 499) {
        return hargaDasar - remainder + 500;
    } else if (remainder >= 501 && remainder <= 999) {
        return hargaDasar - remainder + 1000;
    }
    return hargaDasar;
}
        
// Fungsi untuk menghitung harga
function hitungHarga(form) {
    const itemType = form.find('.item-type').val();
    const fixedPrice = form.find('.fixed-price-select').val();
    const kode = form.find('.kode-select').val();
    const customKode = form.find('.kodeEmas').val();
    const berat = parseFloat(form.find('.beratEmas').val());
    const ongkosType = form.find('.ongkos').val();
    const discount = parseFloat(form.find('.discount').val()) || 0;

    if (isNaN(berat) || berat <= 0) {
        alert("Harap isi berat dengan benar.");
        return;
    }

    let harga = null;
    let itemName = "";
    
    if (itemType === 'fixed') {
        if (!fixedPrice) {
            alert("Harap pilih item harga tetap.");
            return;
        }
        harga = parseInt(fixedPrice);
        itemName = fixedPriceItems[fixedPrice];
    } 
    else if (itemType === 'kode') {
        if (!kode) {
            alert("Harap pilih kode item.");
            return;
        }
        harga = hitungHargaKhusus(kode);
        itemName = kodeItems[kode];
    }
    else if (itemType === 'custom') {
        if (!customKode) {
            alert("Harap masukkan kode emas.");
            return;
        }
        harga = hitungHargaKhusus(customKode);
        itemName = "Kode: " + customKode + "%";
    }
    else {
        alert("Harap pilih jenis item terlebih dahulu.");
        return;
    }
    
    if (harga === null) return;
    
    let hasilAwal = harga * berat;
    let hasilBulat = hasilAwal; // Tidak perlu pembulatan lagi karena sudah dibulatkan di hitungHargaKhusus()

    // Hitung ongkos
    let ongkos = 0;
    if (ongkosType === "15000") {
        ongkos = berat < 1 ? 15000 : 15000 * berat;
    } else if (ongkosType === "5") {
        ongkos = hasilBulat * 0.05;
    } else if (ongkosType === "10") {
        ongkos = hasilBulat * 0.10;
    }

    // Bulatkan ongkos
    let remainder = ongkos % 1000;
    if (remainder >= 1 && remainder <= 499) {
        ongkos = ongkos - remainder + 500;
    } else if (remainder >= 501 && remainder <= 999) {
        ongkos = ongkos - remainder + 1000;
    }

    // Hitung harga sebelum discount
    let hargaSebelumDiscount = hasilBulat + ongkos;

    // Bulatkan harga sebelum discount
    remainder = hargaSebelumDiscount % 1000;
    if (remainder >= 1 && remainder <= 499) {
        hargaSebelumDiscount = hargaSebelumDiscount - remainder + 500;
    } else if (remainder >= 501 && remainder <= 999) {
        hargaSebelumDiscount = hargaSebelumDiscount - remainder + 1000;
    }

    // Hitung harga setelah discount
    let hargaFix = hargaSebelumDiscount - discount;
    
    // Pastikan harga tidak negatif
    if (hargaFix < 0) {
        hargaFix = 0;
    }

    // Update total penjualan
    const previousHargaFix = form.data('hargaFix') || 0;
    totalPenjualan = totalPenjualan - previousHargaFix + hargaFix;
    updateTotalPenjualan(totalPenjualan);

    // Simpan hargaFix ke form
    form.data('hargaFix', hargaFix);

    // Tampilkan detail
    updateDetailPenjualan(form, itemName, berat, harga, hasilAwal, hasilBulat, ongkos, hargaSebelumDiscount, discount, hargaFix);
}

function clearTotalPenjualan() {
    totalPenjualan = 0;
    $('#totalPenjualan').html('');
    $('.detailPenjualan').remove();
}

// Event listener untuk document ready
$(document).ready(function() {
    // Show loading spinner temporarily
    $('.spinner').show();
    setTimeout(function() {
        $('.spinner').hide();
    }, 1000);
    
    // Initialize form elements
  function initializeFormElements(form) {
    // Hide all selectors initially
    form.find('.fixed-price-items').hide();
    form.find('.kode-items').hide();
    form.find('.custom-code-input').hide();
    
    // Item type selection
    form.find('.item-type').on('change', function() {
        const itemType = $(this).val();
        
        // Hide all selectors first
        form.find('.fixed-price-items').hide();
        form.find('.kode-items').hide();
        form.find('.custom-code-input').hide();
        
        // Show the appropriate selector
        if (itemType === 'fixed') {
            form.find('.fixed-price-items').show();
        } 
        else if (itemType === 'kode') {
            form.find('.kode-items').show();
        }
        else if (itemType === 'custom') {
            form.find('.custom-code-input').show();
        }
        
        // Clear any previous selections
        form.find('.fixed-price-select').val('');
        form.find('.kode-select').val('');
        form.find('.kodeEmas').val('');
        form.find('.hargaEmas').val('');
    });
        // Auto-fill harga when fixed price is selected
        form.find('.fixed-price-select').on('change', function() {
            updateHargaPerGram(form);
        });
        
        // Auto-fill harga when kode is selected
        form.find('.kode-select').on('change', function() {
            updateHargaPerGram(form);
        });
        
        // Auto-fill harga when custom kode is entered
        form.find('.kodeEmas').on('input', function() {
            updateHargaPerGram(form);
        });
        
        // Toggle detail button
        form.find('.toggle-detail-btn').off('click').on('click', function() {
            const detailContainer = form.next('.detailPenjualan');
            const isVisible = detailContainer.hasClass('show');
            
            if (isVisible) {
                detailContainer.removeClass('show');
                $(this).html('<i class="fas fa-eye me-1"></i> Tampilkan Detail');
            } else {
                detailContainer.addClass('show');
                $(this).html('<i class="fas fa-eye-slash me-1"></i> Sembunyikan Detail');
            }
        });
        
        // Hitung button
        form.find('.hitungBtn').off('click').on('click', function() {
            hitungHarga(form);
        });
    }
    
    // Initialize first form
    initializeFormElements($('#formEmas'));
    
    // COKIM button
    $('#cokimBtn').on('click', function() {
        const newCokim = prompt("Masukkan nilai COKIM saat ini:", cokim.toLocaleString('id-ID'));
        if (newCokim !== null) {
            // Remove non-numeric characters and parse
            const parsedCokim = parseInt(newCokim.replace(/\D/g, ''));
            if (!isNaN(parsedCokim) && parsedCokim > 0) {
                cokim = parsedCokim;
                alert(`Nilai COKIM berhasil diupdate menjadi Rp. ${cokim.toLocaleString('id-ID')}`);
                
                // Update all forms that have kode entered
                $('.penjualan-form').each(function() {
                    const form = $(this);
                    const itemType = form.find('.item-type').val();
                    
                    if (itemType === 'kode' || itemType === 'custom') {
                        updateHargaPerGram(form);
                        if (form.data('hargaFix') !== undefined) {
                            hitungHarga(form);
                        }
                    }
                });
            } else {
                alert("Masukkan nilai COKIM yang valid!");
            }
        }
    });
    
    // Tambah barang button
    $('.tambahBarangBtn').on('click', function() {
        const formClone = $('#formEmas').clone();
        formClone.find('input, select').val('');
        formClone.find('.discount').val('0');
        formClone.find('.item-type').val('');
        formClone.find('.fixed-price-select').val('');
        formClone.find('.kode-select').val('');
        formClone.find('.kodeEmas').val('');
        formClone.find('.hargaEmas').val('');
        formClone.find('.fixed-price-items').hide();
        formClone.find('.kode-items').hide();
        formClone.find('.custom-code-input').hide();
        formClone.removeAttr('id');
        formClone.find('.delete-btn-container').css('display', 'block');
        formClone.find('.detailPenjualan').remove();
        $('#formContainer').append(formClone);
        
        // Initialize the new form
        initializeFormElements(formClone);
        
        // Scroll to the new form
        $('html, body').animate({
            scrollTop: formClone.offset().top - 100
        }, 500);
    });
    
    // Clear button
    $(document).on('click', '.clearBtn', function() {
        const form = $(this).closest('.penjualan-form');
        const previousHargaFix = form.data('hargaFix') || 0;
        totalPenjualan -= previousHargaFix;
        updateTotalPenjualan(totalPenjualan);
        
        form.removeData('hargaFix');
        form.next('.detailPenjualan').remove();
        
        // Reset toggle button
        form.find('.toggle-detail-btn').html('<i class="fas fa-eye me-1"></i> Tampilkan Detail');
    });
    
    // Delete button
    $(document).on('click', '.deleteBtn', function() {
        const form = $(this).closest('.penjualan-form');
        const previousHargaFix = form.data('hargaFix') || 0;
        totalPenjualan -= previousHargaFix;
        updateTotalPenjualan(totalPenjualan);
        
        form.next('.detailPenjualan').remove();
        form.remove();
    });
    
    // Floating buttons scroll effect
    $(window).scroll(function() {
        if ($(window).scrollTop() > 100) {
            $('.floating-buttons-container').css({
                'bottom': '15px',
                'right': '15px',
                'transition': 'all 0.3s ease'
            });
        } else {
            $('.floating-buttons-container').css({
                'bottom': '15px',
                'right': '15px',
                'transition': 'all 0.3s ease'
            });
        }
    });
    
    // Harga button functionality
    $('#hargaBtn').on('click', function() {
        $('#hargaModal').modal('show');
        loadHargaData();
    });

    function loadHargaData() {
        $('#hargaContainer').html('');
        $('.modal-body .spinner').show();
        
        $.ajax({
            url: 'harga.json', // Make sure this path is correct
            dataType: 'json',
            success: function(data) {
                $('.modal-body .spinner').hide();
                displayHargaData(data);
            },
            error: function() {
                $('.modal-body .spinner').hide();
                $('#hargaContainer').html('<div class="alert alert-danger">Gagal memuat data harga. Silakan coba lagi.</div>');
            }
        });
    }

    function displayHargaData(data) {
        let html = '';
        
        // Process emas data
        html += '<div class="harga-category">Emas</div>';
        html += '<table class="harga-table"><thead><tr><th>Item</th><th>Harga Jual</th></tr></thead><tbody>';
        data.emas.forEach(item => {
            if (item.sellPrice > 0) {
                html += `<tr><td>${item.code}</td><td>Rp. ${item.sellPrice.toLocaleString('id-ID')}</td></tr>`;
            }
        });
        html += '</tbody></table>';
        
        // Process antam data
        html += '<div class="harga-category">Antam</div>';
        html += '<table class="harga-table"><thead><tr><th>Item</th><th>Harga Jual</th></tr></thead><tbody>';
        data.antam.forEach(item => {
            if (item.sellPrice > 0) {
                html += `<tr><td>${item.code}</td><td>Rp. ${item.sellPrice.toLocaleString('id-ID')}</td></tr>`;
            }
        });
        html += '</tbody></table>';
        
        // Process archi data
        html += '<div class="harga-category">Archi</div>';
        html += '<table class="harga-table"><thead><tr><th>Item</th><th>Harga Jual</th></tr></thead><tbody>';
        data.archi.forEach(item => {
            if (item.sellPrice > 0) {
                html += `<tr><td>${item.code}</td><td>Rp. ${item.sellPrice.toLocaleString('id-ID')}</td></tr>`;
            }
        });
        html += '</tbody></table>';
        
        $('#hargaContainer').html(html);
    }

    // Refresh harga when modal is shown
    $('#hargaModal').on('shown.bs.modal', function() {
        loadHargaData();
    });
});
    
</script>
</body>
</html>
