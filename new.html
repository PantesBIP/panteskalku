<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Bagian head tetap sama seperti sebelumnya -->
    <!-- ... -->
</head>

<body>
    <!-- Bagian navbar dan header tetap sama -->
    <!-- ... -->

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header text-center">
                        <!-- Header tetap sama -->
                        <!-- ... -->
                    </div>
                    <div class="card-body">
                        <div id="formContainer">
                            <form id="formEmas" class="penjualan-form">
                                <!-- Form input tetap sama -->
                                <!-- ... -->
                                <div class="form-buttons">
                                    <button type="button" class="btn btn-primary hitungBtn">
                                        <i class="fas fa-calculator me-1"></i> Hitung
                                    </button>
                                    <button type="reset" class="btn btn-danger clearBtn">
                                        <i class="fas fa-eraser me-1"></i> Reset
                                    </button>
                                    <div class="delete-btn-container">
                                        <button type="button" class="btn btn-warning deleteBtn">
                                            <i class="fas fa-trash me-1"></i> Hapus
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-info toggle-detail-btn">
                                    <i class="fas fa-eye me-1"></i> Tampilkan Detail
                                </button>
                            </form>
                        </div>

                        <button type="button" class="btn btn-success mt-3 tambahBarangBtn">
                            <i class="fas fa-plus-circle me-1"></i> Tambah Barang
                        </button>

                        <div id="detailPenjualan" class="mt-4"></div>
                        <div id="totalPenjualan" class="mt-4"></div>
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer tetap sama -->
    <!-- ... -->

    <script>
        // Variabel global dan fungsi loadHargaEmas tetap sama
        // ...

        // Fungsi untuk mengupdate pilihan kode emas berdasarkan kategori
        function updateKodeEmasOptions(form, kategori) {
            const kodeEmasSelect = form.find('.kodeEmas');
            const selectedValue = kodeEmasSelect.val();
            
            kodeEmasSelect.empty().append('<option value="" selected disabled>Pilih Kode Emas</option>');
            
            kodeEmasOptions[kategori].forEach(option => {
                kodeEmasSelect.append(`<option value="${option.value}">${option.text}</option>`);
            });
            
            // Reinitialize Select2
            kodeEmasSelect.select2('destroy');
            initializeFormElements(form);
            
            // Reset harga
            form.find('.hargaEmas').val('');
        }

        // Initialize Select2 and other elements
        function initializeFormElements(form) {
            form.find('.select2').select2({
                placeholder: "Pilih Kode Emas",
                allowClear: true,
                width: '100%',
                dropdownParent: form.closest('#formContainer')
            });
            
            // Auto-fill harga when kode is selected
            form.find('.kodeEmas').on('change', function() {
                const kode = $(this).val();
                form.find('.hargaEmas').val(hargaEmas[kode] ? hargaEmas[kode].toLocaleString('id-ID') : '');
            });
            
            // Update kode emas options when kategori changes
            form.find('.kategoriEmas').on('change', function() {
                const kategori = $(this).val();
                updateKodeEmasOptions(form, kategori);
            });
            
            // Toggle detail button
            form.find('.toggle-detail-btn').on('click', function() {
                const detailContainer = form.next('.detailPenjualan');
                detailContainer.toggleClass('show');
                
                // Update button text and icon
                if (detailContainer.hasClass('show')) {
                    $(this).html('<i class="fas fa-eye-slash me-1"></i> Sembunyikan Detail');
                } else {
                    $(this).html('<i class="fas fa-eye me-1"></i> Tampilkan Detail');
                }
            });
        }

        function calculatePrice(kode, berat) {
            // Fungsi calculatePrice tetap sama
            // ...
        }

        function updateTotalPenjualan(newTotal) {
            totalPenjualan = newTotal;
            $('#totalPenjualan').html(`<h3>Total Penjualan: Rp. ${totalPenjualan.toLocaleString('id-ID')}</h3>`);
        }

        function updateDetailPenjualan(form, kode, berat, harga, hasilAwal, hasilBulat, tambahan5Persen, tambahan10Persen, potonganAwal, hargaFix) {
            const detailHtml = `
                <div class="detailPenjualan show"> <!-- Tambahkan class show secara default -->
                    <h5><i class="fas fa-info-circle me-2"></i>Detail Perhitungan</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Kode:</strong> ${kode}</p>
                            <p><strong>Berat:</strong> ${berat} gram</p>
                            <p><strong>Harga per gram:</strong> Rp. ${harga.toLocaleString('id-ID')}</p>
                        </div>
                        <div class="col-md-6">
                            <ul>
                                <li>Harga Awal: Rp. ${hasilAwal.toLocaleString('id-ID')}</li>
                                <li>Harga Bulat: Rp. ${hasilBulat.toLocaleString('id-ID')}</li>
                                ${tambahan5Persen > 0 ? `<li>Tambahan 5%: Rp. ${tambahan5Persen.toLocaleString('id-ID')}</li>` : ''}
                                ${tambahan10Persen > 0 ? `<li>Tambahan 10%: Rp. ${tambahan10Persen.toLocaleString('id-ID')}</li>` : ''}
                                ${potonganAwal > 0 ? `<li>Potongan Awal: Rp. ${potonganAwal.toLocaleString('id-ID')}</li>` : ''}
                                <li class="fw-bold">Harga Final: Rp. ${hargaFix.toLocaleString('id-ID')}</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            form.next('.detailPenjualan').remove();
            form.after(detailHtml);
            
            // Update tombol toggle untuk menampilkan "Sembunyikan Detail"
            form.find('.toggle-detail-btn').html('<i class="fas fa-eye-slash me-1"></i> Sembunyikan Detail');
        }

        function clearTotalPenjualan() {
            totalPenjualan = 0;
            $('#totalPenjualan').html('');
            $('.detailPenjualan').remove();
        }

        $(document).on('click', '.hitungBtn', function () {
            const form = $(this).closest('.penjualan-form');
            const kode = form.find('.kodeEmas').val();
            const berat = parseFloat(form.find('.beratEmas').val());

            if (!kode || isNaN(berat) || berat <= 0) {
                alert("Harap pilih kode emas dan isi berat dengan benar.");
                return;
            }

            const { harga, hasilAwal, hasilBulat, tambahan5Persen, tambahan10Persen, potonganAwal, hargaFix } = calculatePrice(kode, berat);

            const previousHargaFix = form.data('hargaFix');
            if (previousHargaFix) {
                totalPenjualan -= previousHargaFix;
            }

            totalPenjualan += hargaFix;

            updateDetailPenjualan(form, kode, berat, harga, hasilAwal, hasilBulat, tambahan5Persen, tambahan10Persen, potonganAwal, hargaFix);
            updateTotalPenjualan(totalPenjualan);

            form.data('hargaFix', hargaFix);
        });

        // Fungsi lainnya tetap sama
        // ...

        // Panggil fungsi loadHargaEmas saat dokumen siap
        $(document).ready(function() {
            loadHargaEmas();
            
            // Show loading spinner temporarily (demo purposes)
            $('.spinner').show();
            setTimeout(function() {
                $('.spinner').hide();
            }, 1000);
        });
    </script>
</body>
</html>
