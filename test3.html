<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Powered By - Toko Mas Pantes BIP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #d4af37;
            --secondary-color: #343a40;
            --accent-color: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .navbar {
            background-color: var(--secondary-color) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
            font-size: 1.5rem;
        }

        .nav-link {
            color: white !important;
            transition: all 0.3s;
        }

        .nav-link:hover {
            color: var(--primary-color) !important;
            transform: translateY(-2px);
        }

        .container {
            max-width: 1200px;
        }

        .card {
            border-radius: 10px;
            box-shadow:  0 4px 20px rgba(0,0,0,0.08);
            border: none;
            margin-bottom: 2rem;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            border-radius: 10px 10px 0 0 !important;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #c9a227;
            border-color: #c9a227;
        }

        .btn-success {
            background-color: #28a745;
        }

        .btn-danger {
            background-color: #dc3545;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(212, 175, 55, 0.25);
        }

        footer {
            background-color: var(--secondary-color);
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .delete-btn-container {
            display: none;
        }

        .detailPenjualan {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            margin-top: 1rem;
            display: none;
        }

        .detailPenjualan.show {
            display: block;
        }

        .detailPenjualan h5 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .detailPenjualan ul {
            list-style-type: none;
            padding-left: 0;
        }

        .detailPenjualan li {
            padding: 0.3rem 0;
            border-bottom: 1px solid #eee;
        }

        .detailPenjualan li:last-child {
            border-bottom: none;
            font-weight: bold;
            color: var(--primary-color);
        }

        #totalPenjualan h3 {
            color: var(--primary-color);
            font-weight: 700;
            text-align: center;
            padding: 1rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
        }

        .tambahBarangBtn {
            width: 100%;
            padding: 10px;
            font-weight: 600;
        }

        .toggle-detail-btn {
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .col-form-label {
                text-align: left !important;
                padding-bottom: 0;
            }
            
            .form-buttons {
                justify-content: center;
            }
            
            .btn {
                flex: 1;
                min-width: 120px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .penjualan-form {
            animation: fadeIn 0.5s ease-out;
        }

        .spinner {
            display: none;
            margin: 20px auto;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Floating button styles */
        .floating-cokim {
            position: fixed;
            bottom: 90px;
            right: 20px;
            z-index: 99;
        }

        /* Floating buttons container */
.floating-buttons-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 99;
    display: flex;
    flex-direction: column-reverse;
    gap: 10px;
    align-items: flex-end;
}

.floating-btn-wrapper {
    transition: all 0.3s ease;
}

/* Base button styles for both buttons */
.btn-harga, .btn-cokim {
    color: white;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    transition: all 0.3s ease;
    border-radius: 50%;
    width: 50px;
    height: 50px;
}

.btn-harga {
    background-color: #28a745;
}

.btn-cokim {
    background-color: var(--primary-color);
}

.btn-harga:hover, .btn-cokim:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 15px rgba(0,0,0,0.4);
}

.btn-harga i, .btn-cokim i {
    font-size: 20px;
}

.btn-harga .text, .btn-cokim .text {
    display: none;
}

/* Desktop styles */
@media (min-width: 768px) {
    .btn-harga, .btn-cokim {
        width: auto;
        height: auto;
        padding: 10px 15px;
        border-radius: 30px;
    }
    
    .btn-harga i, .btn-cokim i {
        margin-right: 8px;
        font-size: 16px;
        }
        
        .btn-harga .text, .btn-cokim .text {
            display: inline;
            font-size: 14px;
        }
        
        .floating-buttons-container {
            gap: 15px;
        }
    }

    /* Animation when scrolling */
    @media (max-width: 767px) {
        .floating-buttons-container {
            bottom: 15px;
            right: 15px;
        }
        
        .btn-harga, .btn-cokim {
            width: 45px;
            height: 45px;
        }
        
        .btn-harga i, .btn-cokim i {
            font-size: 18px;
        }
    }

        .btn-cokim {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-cokim:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }

        .btn-cokim i {
            font-size: 24px;
        }

        .btn-cokim .text {
            display: none;
        }

        @media (min-width: 768px) {
            .btn-cokim {
                width: auto;
                height: auto;
                padding: 12px 20px;
                border-radius: 30px;
            }
            
            .btn-cokim i {
                margin-right: 8px;
            }
            
            .btn-cokim .text {
                display: inline;
            }
        }
        
        /* Fixed price items selector */
        .fixed-price-selector {
            margin-bottom: 15px;
        }
        
        .fixed-price-selector select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ced4da;
        }
        /* Add to your existing styles */
.btn-harga {
    background-color: #28a745;
    color: white;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    transition: all 0.3s ease;
}

.btn-harga:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 15px rgba(0,0,0,0.4);
}

.btn-harga i {
    font-size: 24px;
}

.btn-harga .text {
    display: none;
}

@media (min-width: 768px) {
    .btn-harga {
        width: auto;
        height: auto;
        padding: 12px 20px;
        border-radius: 30px;
    }
    
    .btn-harga i {
        margin-right: 8px;
    }
    
    .btn-harga .text {
        display: inline;
    }
}

/* Table styles */
.harga-table {
    width: 100%;
    border-collapse: collapse;
}

.harga-table th, .harga-table td {
    padding: 8px 12px;
    border: 1px solid #ddd;
    text-align: left;
}

.harga-table th {
    background-color: var(--primary-color);
    color: white;
}

.harga-table tr:nth-child(even) {
    background-color: #f2f2f2;
}

.harga-table tr:hover {
    background-color: #e9e9e9;
}

.harga-category {
    margin-top: 20px;
    margin-bottom: 10px;
    color: var(--primary-color);
    font-weight: bold;
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 5px;
}

/* Kode items selector */
.kode-selector {
    margin-bottom: 15px;
}

.kode-selector select {
    width: 100%;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #ced4da;
}

/* Tabs styling */
.nav-tabs {
    border-bottom: 2px solid #dee2e6;
    margin-bottom: 15px;
}

.nav-tabs .nav-link {
    color: #495057;
    border: none;
    padding: 10px 20px;
    font-weight: 600;
}

.nav-tabs .nav-link.active {
    color: var(--primary-color);
    background-color: transparent;
    border-bottom: 3px solid var(--primary-color);
}

.nav-tabs .nav-link:hover {
    border-color: transparent;
    color: var(--primary-color);
}

.tab-content {
    padding: 15px 0;
}
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-gem me-2"></i>Toko Mas Pantes BIP
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="https://pntsharga.netlify.app/trend">
                            <i class="fas fa-globe me-1"></i> Trend emas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://pntsharga.netlify.app">
                            <i class="fas fa-calculator me-1"></i> HARGA UPDATE
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header text-center">
                        <h3>No Rek</h3>
                        <label>|| BCA: 3747-7721-11</label> <label> || Mandiri : 1340-5000-8111-1 ||</label>
                        <p>A/n Markus W</p>
                        <label>Untuk Barang Amero dengan kode tertentu Naik satu barcode contoh 84.5 jadi 85.5</label>
                        <label>JUENE = 39, BG 8K = 46, ILY = 54, VOILA = 55, 16K BG & Hala = 77, 17K Biasa & Amero = 85, 
                                16K LPM = 80, 18 K LPM = 88, SDWLPM-92 = barcode x cokim
                        </label>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="harga-tetap-tab" data-bs-toggle="tab" data-bs-target="#harga-tetap" type="button" role="tab" aria-controls="harga-tetap" aria-selected="true">Harga Tetap</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="hitung-kode-tab" data-bs-toggle="tab" data-bs-target="#hitung-kode" type="button" role="tab" aria-controls="hitung-kode" aria-selected="false">Hitung Kode</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="myTabContent">
                            <div class="tab-pane fade show active" id="harga-tetap" role="tabpanel" aria-labelledby="harga-tetap-tab">
                                <div id="formContainer">
                                    <form id="formEmas" class="penjualan-form">
                                        <div class="fixed-price-selector">
                                            <select class="form-select fixed-price-items">
                                                <option value="">-- Pilih Item Harga Tetap --</option>
                                                <option value="770000">8k Kuning</option>
                                                <option value="800000">8k Putih</option>
                                                <option value="825000">9k Kuning</option>
                                                <option value="845000">9k Putih</option>
                                            </select>
                                        </div>
                                        <div class="row mb-3">
                                            <label for="kodeEmas" class="col-sm-3 col-form-label">Kode Emas</label>
                                            <div class="col-sm-9">
                                                <input type="text" class="form-control kodeEmas" placeholder="Masukkan kode emas (contoh: 84.5, 85.5, 90.5)">
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <label for="hargaEmas" class="col-sm-3 col-form-label">Harga per gram</label>
                                            <div class="col-sm-9">
                                                <div class="input-group">
                                                    <span class="input-group-text">Rp</span>
                                                    <input type="text" class="form-control hargaEmas" readonly>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <label for="ongkos" class="col-sm-3 col-form-label">Ongkos</label>
                                            <div class="col-sm-9">
                                                <select class="form-select ongkos" required>
                                                    <option value="0">Tidak ada ongkos</option>
                                                    <option value="15000">15 ribu x graman</option>
                                                    <option value="5">5% x harga bulat</option>
                                                    <option value="10">10% x harga bulat</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <label for="beratEmas" class="col-sm-3 col-form-label">Berat Emas</label>
                                            <div class="col-sm-9">
                                                <div class="input-group">
                                                    <input type="number" class="form-control beratEmas" required step="0.01" min="0.01">
                                                    <span class="input-group-text">gram</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <label for="discount" class="col-sm-3 col-form-label">Discount</label>
                                            <div class="col-sm-9">
                                                <div class="input-group">
                                                    <span class="input-group-text">Rp</span>
                                                    <input type="number" class="form-control discount" value="0" min="0">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-buttons">
                                            <button type="button" class="btn btn-primary hitungBtn">
                                                <i class="fas fa-calculator me-1"></i> Hitung
                                            </button>
                                            <button type="reset" class="btn btn-danger clearBtn">
                                                <i class="fas fa-eraser me-1"></i> Reset
                                            </button>
                                            <div class="delete-btn-container">
                                                <button type="button" class="btn btn-warning deleteBtn">
                                                    <i class="fas fa-trash me-1"></i> Hapus
                                                </button>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-info toggle-detail-btn">
                                            <i class="fas fa-eye me-1"></i> Tampilkan Detail
                                        </button>
                                    </form>
                                </div>

                                <button type="button" class="btn btn-success mt-3 tambahBarangBtn">
                                    <i class="fas fa-plus-circle me-1"></i> Tambah Barang
                                </button>

                                <div id="detailPenjualan" class="mt-4"></div>
                                <div id="totalPenjualan" class="mt-4"></div>
                                <div class="spinner"></div>
                            </div>
                            <div class="tab-pane fade" id="hitung-kode" role="tabpanel" aria-labelledby="hitung-kode-tab">
                                <div id="formContainerKode">
                                    <form id="formKode" class="penjualan-form">
                                        <div class="kode-selector">
                                            <select class="form-select kode-items">
                                                <option value="">-- Pilih Kode Item --</option>
                                                <option value="39">JUENE (39%)</option>
                                                <option value="46">BG 8K (46%)</option>
                                                <option value="54">ILY (54%)</option>
                                                <option value="55">VOILA (55%)</option>
                                                <option value="77">16K BG & Hala (77%)</option>
                                                <option value="85">17K Biasa & Amero (85%)</option>
                                                <option value="80">16K LPM (80%)</option>
                                                <option value="88">18K LPM (88%)</option>
                                            </select>
                                        </div>
                                        <div class="row mb-3">
                                            <label for="kodePersen" class="col-sm-3 col-form-label">Kode Persen</label>
                                            <div class="col-sm-9">
                                                <div class="input-group">
                                                    <input type="number" class="form-control kodePersen" placeholder="Masukkan kode persen (contoh: 39, 46, 54)">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <label for="hargaPerGram" class="col-sm-3 col-form-label">Harga per gram</label>
                                            <div class="col-sm-9">
                                                <div class="input-group">
                                                    <span class="input-group-text">Rp</span>
                                                    <input type="text" class="form-control hargaPerGram" readonly>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <label for="ongkosKode" class="col-sm-3 col-form-label">Ongkos</label>
                                            <div class="col-sm-9">
                                                <select class="form-select ongkosKode" required>
                                                    <option value="0">Tidak ada ongkos</option>
                                                    <option value="15000">15 ribu x graman</option>
                                                    <option value="5">5% x harga bulat</option>
                                                    <option value="10">10% x harga bulat</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <label for="beratEmasKode" class="col-sm-3 col-form-label">Berat Emas</label>
                                            <div class="col-sm-9">
                                                <div class="input-group">
                                                    <input type="number" class="form-control beratEmasKode" required step="0.01" min="0.01">
                                                    <span class="input-group-text">gram</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <label for="discountKode" class="col-sm-3 col-form-label">Discount</label>
                                            <div class="col-sm-9">
                                                <div class="input-group">
                                                    <span class="input-group-text">Rp</span>
                                                    <input type="number" class="form-control discountKode" value="0" min="0">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-buttons">
                                            <button type="button" class="btn btn-primary hitungBtnKode">
                                                <i class="fas fa-calculator me-1"></i> Hitung
                                            </button>
                                            <button type="reset" class="btn btn-danger clearBtnKode">
                                                <i class="fas fa-eraser me-1"></i> Reset
                                            </button>
                                            <div class="delete-btn-container">
                                                <button type="button" class="btn btn-warning deleteBtnKode">
                                                    <i class="fas fa-trash me-1"></i> Hapus
                                                </button>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-info toggle-detail-btn">
                                            <i class="fas fa-eye me-1"></i> Tampilkan Detail
                                        </button>
                                    </form>
                                </div>

                                <button type="button" class="btn btn-success mt-3 tambahBarangBtnKode">
                                    <i class="fas fa-plus-circle me-1"></i> Tambah Barang
                                </button>

                                <div id="detailPenjualanKode" class="mt-4"></div>
                                <div id="totalPenjualanKode" class="mt-4"></div>
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
       <!-- Floating Harga -->
    <div class="floating-harga" style="position: fixed; bottom: 160px; right: 20px; z-index: 99;">
        <button class="btn btn-harga" id="hargaBtn" title="Lihat Harga Emas">
            <i class="fas fa-table"></i>
            <span class="text">Harga</span>
        </button>
    </div>
    
    <!-- Add this modal at the bottom of your body, before the scripts -->
    <div class="modal fade" id="hargaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Daftar Harga Emas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="spinner text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div id="hargaContainer"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating button for COKIM input -->
    <div class="floating-cokim">
        <button class="btn btn-cokim" id="cokimBtn" title="Set COKIM Value">
            <i class="fas fa-coins"></i>
            <span class="text">COKIM</span>
        </button>
    </div>

    <footer class="text-center">
        <div class="container">
            <div class="mb-3">
                <a href="https://www.instagram.com/tokomaspantes_bandung/" class="text-white me-3"><i class="fab fa-instagram fa-lg"></i></a>
                <a href="https://api.whatsapp.com/send/?phone=%2B6289656737562&text&type=phone_number&app_absent=0" class="text-white"><i class="fab fa-whatsapp fa-lg"></i></a>
            </div>
            <p>&copy; 2024 Toko Mas. All rights reserved.</p>
            <p class="text-muted">Created with <i class="fas fa-heart text-danger"></i> by kc</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
   // Variabel global
let cokim = 1743000; // Default COKIM value
let totalPenjualan = 0;
let totalPenjualanKode = 0;

// Fixed price items
const fixedPriceItems = {
    "770000": "8k Kuning",
    "800000": "8k Putih",
    "825000": "9k Kuning",
    "845000": "9k Putih"
};

// Kode items
const kodeItems = {
    "39": "JUENE (39%)",
    "46": "BG 8K (46%)",
    "54": "ILY (54%)",
    "55": "VOILA (55%)",
    "77": "16K BG & Hala (77%)",
    "85": "17K Biasa & Amero (85%)",
    "80": "16K LPM (80%)",
    "88": "18K LPM (88%)"
};

// Fungsi untuk menghitung harga berdasarkan kode manual dengan pembulatan sesuai aturan
function hitungHargaKhusus(kode) {
    // Check if this is a fixed price item
    if (fixedPriceItems.hasOwnProperty(kode)) {
        return parseInt(kode);
    }
    
    // Validasi kode harus berupa angka antara 0 dan 100 (hanya untuk non-fixed price items)
    const persentase = parseFloat(kode);
    if (isNaN(persentase) || persentase <= 0 || persentase > 100) {
        alert("Kode emas harus berupa angka antara 0 dan 100");
        return null;
    }
    
    const persentaseDecimal = persentase / 100;
    let hargaDasar = cokim * persentaseDecimal;
    
    // Bulatkan ke 500 atau 1000
    let remainder = hargaDasar % 1000;
    if (remainder >= 1 && remainder <= 499) {
        hargaDasar = hargaDasar - remainder + 500;
    } else if (remainder >= 501 && remainder <= 999) {
        hargaDasar = hargaDasar - remainder + 1000;
    }
    
    return Math.round(hargaDasar);
}

// Fungsi untuk menghitung harga berdasarkan kode persen
function hitungHargaKode(persen) {
    if (isNaN(persen) || persen <= 0 || persen > 100) {
        alert("Kode persen harus berupa angka antara 0 dan 100");
        return null;
    }
    
    const persentaseDecimal = persen / 100;
    let hargaDasar = cokim * persentaseDecimal;
    
    // Bulatkan ke 500 atau 1000
    let remainder = hargaDasar % 1000;
    if (remainder >= 1 && remainder <= 499) {
        hargaDasar = hargaDasar - remainder + 500;
    } else if (remainder >= 501 && remainder <= 999) {
        hargaDasar = hargaDasar - remainder + 1000;
    }
    
    return Math.round(hargaDasar);
}

// Fungsi untuk mengupdate harga per gram berdasarkan kode yang dimasukkan
function updateHargaPerGram(form) {
    const kode = form.find('.kodeEmas').val();
    const fixedPrice = form.find('.fixed-price-items').val();
    
    // Prioritize fixed price selection
    if (fixedPrice) {
        form.find('.hargaEmas').val(parseInt(fixedPrice).toLocaleString('id-ID'));
        form.find('.kodeEmas').val('').prop('disabled', true);
    } else {
        form.find('.kodeEmas').prop('disabled', false);
        if (!kode) {
            form.find('.hargaEmas').val('');
            return;
        }
        
        const harga = hitungHargaKhusus(kode);
        if (harga !== null) {
            form.find('.hargaEmas').val(harga.toLocaleString('id-ID'));
        } else {
            form.find('.hargaEmas').val('');
        }
    }
}

// Fungsi untuk mengupdate harga per gram berdasarkan kode persen
function updateHargaPerGramKode(form) {
    const kode = form.find('.kodePersen').val();
    const selectedKode = form.find('.kode-items').val();
    
    // Prioritize selected kode
    if (selectedKode) {
        form.find('.kodePersen').val(selectedKode);
        const harga = hitungHargaKode(selectedKode);
        if (harga !== null) {
            form.find('.hargaPerGram').val(harga.toLocaleString('id-ID'));
        } else {
            form.find('.hargaPerGram').val('');
        }
    } else {
        if (!kode) {
            form.find('.hargaPerGram').val('');
            return;
        }
        
        const harga = hitungHargaKode(kode);
        if (harga !== null) {
            form.find('.hargaPerGram').val(harga.toLocaleString('id-ID'));
        } else {
            form.find('.hargaPerGram').val('');
        }
    }
}

// Fungsi untuk menghitung harga
function hitungHarga(form) {
    const fixedPrice = form.find('.fixed-price-items').val();
    const kode = fixedPrice || form.find('.kodeEmas').val();
    const berat = parseFloat(form.find('.beratEmas').val());
    const ongkosType = form.find('.ongkos').val();
    const discount = parseFloat(form.find('.discount').val()) || 0;

    if (!kode || isNaN(berat) || berat <= 0) {
        alert("Harap isi kode emas dan berat dengan benar.");
        return;
    }

    const harga = hitungHargaKhusus(kode);
    if (harga === null) return;
    
    let hasilAwal = harga * berat;
    let hasilBulat = hasilAwal; // Tidak perlu pembulatan lagi karena sudah dibulatkan di hitungHargaKhusus()

    // Hitung ongkos
    let ongkos = 0;
    if (ongkosType === "15000") {
        ongkos = berat < 1 ? 15000 : 15000 * berat;
    } else if (ongkosType === "5") {
        ongkos = hasilBulat * 0.05;
    } else if (ongkosType === "10") {
        ongkos = hasilBulat * 0.10;
    }

    // Bulatkan ongkos
    let remainder = ongkos % 1000;
    if (remainder >= 1 && remainder <= 499) {
        ongkos = ongkos - remainder + 500;
    } else if (remainder >= 501 && remainder <= 999) {
        ongkos = ongkos - remainder + 1000;
    }

    // Hitung harga sebelum discount
    let hargaSebelumDiscount = hasilBulat + ongkos;

    // Bulatkan harga sebelum discount
    remainder = hargaSebelumDiscount % 1000;
    if (remainder >= 1 && remainder <= 499) {
        hargaSebelumDiscount = hargaSebelumDiscount - remainder + 500;
    } else if (remainder >= 501 && remainder <= 999) {
        hargaSebelumDiscount = hargaSebelumDiscount - remainder + 1000;
    }

    // Hitung harga setelah discount
    let hargaFix = hargaSebelumDiscount - discount;
    
    // Pastikan harga tidak negatif
    if (hargaFix < 0) {
        hargaFix = 0;
    }

    // Update total penjualan
    const previousHargaFix = form.data('hargaFix') || 0;
    totalPenjualan = totalPenjualan - previousHargaFix + hargaFix;
    updateTotalPenjualan(totalPenjualan);

    // Simpan hargaFix ke form
    form.data('hargaFix', hargaFix);

    // Tampilkan detail
    updateDetailPenjualan(form, kode, berat, harga, hasilAwal, hasilBulat, ongkos, hargaSebelumDiscount, discount, hargaFix);
}

// Fungsi untuk menghitung harga kode
function hitungHargaKodeForm(form) {
    const selectedKode = form.find('.kode-items').val();
    const kode = selectedKode || form.find('.kodePersen').val();
    const berat = parseFloat(form.find('.beratEmasKode').val());
    const ongkosType = form.find('.ongkosKode').val();
    const discount = parseFloat(form.find('.discountKode').val()) || 0;

    if (!kode || isNaN(berat) || berat <= 0) {
        alert("Harap isi kode persen dan berat dengan benar.");
        return;
    }

    const harga = hitungHargaKode(kode);
    if (harga === null) return;
    
    let hasilAwal = harga * berat;
    let hasilBulat = hasilAwal; // Tidak perlu pembulatan lagi karena sudah dibulatkan di hitungHargaKode()

    // Hitung ongkos
    let ongkos = 0;
    if (ongkosType === "15000") {
        ongkos = berat < 1 ? 15000 : 15000 * berat;
    } else if (ongkosType === "5") {
        ongkos = hasilBulat * 0.05;
    } else if (ongkosType === "10") {
        ongkos = hasilBulat * 0.10;
    }

    // Bulatkan ongkos
    let remainder = ongkos % 1000;
    if (remainder >= 1 && remainder <= 499) {
        ongkos = ongkos - remainder + 500;
    } else if (remainder >= 501 && remainder <= 999) {
        ongkos = ongkos - remainder + 1000;
    }

    // Hitung harga sebelum discount
    let hargaSebelumDiscount = hasilBulat + ongkos;

    // Bulatkan harga sebelum discount
    remainder = hargaSebelumDiscount % 1000;
    if (remainder >= 1 && remainder <= 499) {
        hargaSebelumDiscount = hargaSebelumDiscount - remainder + 500;
    } else if (remainder >= 501 && remainder <= 999) {
        hargaSebelumDiscount = hargaSebelumDiscount - remainder + 1000;
    }

    // Hitung harga setelah discount
    let hargaFix = hargaSebelumDiscount - discount;
    
    // Pastikan harga tidak negatif
    if (hargaFix < 0) {
        hargaFix = 0;
    }

    // Update total penjualan
    const previousHargaFix = form.data('hargaFix') || 0;
    totalPenjualanKode = totalPenjualanKode - previousHargaFix + hargaFix;
    updateTotalPenjualanKode(totalPenjualanKode);

    // Simpan hargaFix ke form
    form.data('hargaFix', hargaFix);

    // Tampilkan detail
    updateDetailPenjualanKode(form, kode, berat, harga, hasilAwal, hasilBulat, ongkos, hargaSebelumDiscount, discount, hargaFix);
}

function updateTotalPenjualan(newTotal) {
    totalPenjualan = newTotal;
    $('#totalPenjualan').html(`<h3>Total Penjualan: Rp. ${totalPenjualan.toLocaleString('id-ID')}</h3>`);
}

function updateTotalPenjualanKode(newTotal) {
    totalPenjualanKode = newTotal;
    $('#totalPenjualanKode').html(`<h3>Total Penjualan: Rp. ${totalPenjualanKode.toLocaleString('id-ID')}</h3>`);
}

function updateDetailPenjualan(form, kode, berat, harga, hasilAwal, hasilBulat, ongkos, hargaSebelumDiscount, discount, hargaFix) {
    let detailHtml = '';
    
    if (fixedPriceItems.hasOwnProperty(kode)) {
        // Fixed price item
        detailHtml = `
            <div class="detailPenjualan show">
                <h5><i class="fas fa-info-circle me-2"></i>Detail Perhitungan (Harga Tetap)</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Item:</strong> ${fixedPriceItems[kode]}</p>
                        <p><strong>Berat:</strong> ${berat} gram</p>
                    </div>
                    <div class="col-md-6">
                        <ul>
                            <li>Harga per gram: Rp. ${harga.toLocaleString('id-ID')}</li>
                            <li>Harga Awal (Harga x Berat): Rp. ${(harga * berat).toLocaleString('id-ID')}</li>
                            <li>Harga Bulat: Rp. ${hasilBulat.toLocaleString('id-ID')}</li>
                            ${ongkos > 0 ? `<li>Ongkos: Rp. ${ongkos.toLocaleString('id-ID')}</li>` : ''}
                            <li>Harga Sebelum Discount: Rp. ${hargaSebelumDiscount.toLocaleString('id-ID')}</li>
                            ${discount > 0 ? `<li>Discount: Rp. ${discount.toLocaleString('id-ID')}</li>` : ''}
                            <li class="fw-bold">Harga Final: Rp. ${hargaFix.toLocaleString('id-ID')}</li>
                        </ul>
                    </div>
                </div>
            </div>
        `;
    } else {
        // Percentage-based item
        const persentase = parseFloat(kode);
        const persentaseDecimal = persentase / 100;
        const hargaDasar = cokim * persentaseDecimal;
        
        // Proses pembulatan
        let remainder = hargaDasar % 1000;
        let hargaDasarBulat = remainder >= 1 && remainder <= 499 ? 
            hargaDasar - remainder + 500 : 
            remainder >= 501 && remainder <= 999 ? 
            hargaDasar - remainder + 1000 : 
            hargaDasar;
        
        detailHtml = `
            <div class="detailPenjualan show">
                <h5><i class="fas fa-info-circle me-2"></i>Detail Perhitungan</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Kode:</strong> ${kode}%</p>
                        <p><strong>Berat:</strong> ${berat} gram</p>
                        <p><strong>COKIM:</strong> Rp. ${cokim.toLocaleString('id-ID')}</p>
                        <p><strong>Detail Perhitungan:</strong></p>
                        <ol>
                            <li>COKIM × ${kode}% = ${cokim.toLocaleString('id-ID')} × ${kode}% = Rp. ${hargaDasar.toLocaleString('id-ID')}</li>
                            <li>Pembulatan: Rp. ${hargaDasarBulat.toLocaleString('id-ID')}</li>
                        </ol>
                    </div>
                    <div class="col-md-6">
                        <ul>
                            <li>Harga per gram: Rp. ${harga.toLocaleString('id-ID')}</li>
                            <li>Harga Awal (Harga x Berat): Rp. ${(harga * berat).toLocaleString('id-ID')}</li>
                            <li>Harga Bulat: Rp. ${hasilBulat.toLocaleString('id-ID')}</li>
                            ${ongkos > 0 ? `<li>Ongkos: Rp. ${ongkos.toLocaleString('id-ID')}</li>` : ''}
                            <li>Harga Sebelum Discount: Rp. ${hargaSebelumDiscount.toLocaleString('id-ID')}</li>
                            ${discount > 0 ? `<li>Discount: Rp. ${discount.toLocaleString('id-ID')}</li>` : ''}
                            <li class="fw-bold">Harga Final: Rp. ${hargaFix.toLocaleString('id-ID')}</li>
                        </ul>
                    </div>
                </div>
            </div>
        `;
    }
    
    form.next('.detailPenjualan').remove();
    form.after(detailHtml);
    
    form.find('.toggle-detail-btn').html('<i class="fas fa-eye-slash me-1"></i> Sembunyikan Detail');
}

function updateDetailPenjualanKode(form, kode, berat, harga, hasilAwal, hasilBulat, ongkos, hargaSebelumDiscount, discount, hargaFix) {
    let detailHtml = '';
    
    const persentase = parseFloat(kode);
    const persentaseDecimal = persentase / 100;
    const hargaDasar = cokim * persentaseDecimal;
    
    // Proses pembulatan
    let remainder = hargaDasar % 1000;
    let hargaDasarBulat = remainder >= 1 && remainder <= 499 ? 
        hargaDasar - remainder + 500 : 
        remainder >= 501 && remainder <= 999 ? 
        hargaDasar - remainder + 1000 : 
        hargaDasar;
    
    detailHtml = `
        <div class="detailPenjualan show">
            <h5><i class="fas fa-info-circle me-2"></i>Detail Perhitungan Kode</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Kode:</strong> ${kodeItems[kode] || kode + '%'}</p>
                    <p><strong>Berat:</strong> ${berat} gram</p>
                    <p><strong>COKIM:</strong> Rp. ${cokim.toLocaleString('id-ID')}</p>
                    <p><strong>Detail Perhitungan:</strong></p>
                    <ol>
                        <li>COKIM × ${kode}% = ${cokim.toLocaleString('id-ID')} × ${kode}% = Rp. ${hargaDasar.toLocaleString('id-ID')}</li>
                        <li>Pembulatan: Rp. ${hargaDasarBulat.toLocaleString('id-ID')}</li>
                    </ol>
                </div>
                <div class="col-md-6">
                    <ul>
                        <li>Harga per gram: Rp. ${harga.toLocaleString('id-ID')}</li>
                        <li>Harga Awal (Harga x Berat): Rp. ${(harga * berat).toLocaleString('id-ID')}</li>
                        <li>Harga Bulat: Rp. ${hasilBulat.toLocaleString('id-ID')}</li>
                        ${ongkos > 0 ? `<li>Ongkos: Rp. ${ongkos.toLocaleString('id-ID')}</li>` : ''}
                        <li>Harga Sebelum Discount: Rp. ${hargaSebelumDiscount.toLocaleString('id-ID')}</li>
                        ${discount > 0 ? `<li>Discount: Rp. ${discount.toLocaleString('id-ID')}</li>` : ''}
                        <li class="fw-bold">Harga Final: Rp. ${hargaFix.toLocaleString('id-ID')}</li>
                    </ul>
                </div>
            </div>
        </div>
    `;
    
    form.next('.detailPenjualan').remove();
    form.after(detailHtml);
    
    form.find('.toggle-detail-btn').html('<i class="fas fa-eye-slash me-1"></i> Sembunyikan Detail');
}

function clearTotalPenjualan() {
    totalPenjualan = 0;
    $('#totalPenjualan').html('');
    $('.detailPenjualan').remove();
}

function clearTotalPenjualanKode() {
    totalPenjualanKode = 0;
    $('#totalPenjualanKode').html('');
    $('.detailPenjualan').remove();
}

// Event listener untuk document ready
$(document).ready(function() {
    // Show loading spinner temporarily
    $('.spinner').show();
    setTimeout(function() {
        $('.spinner').hide();
    }, 1000);
    
    // Initialize form elements
    function initializeFormElements(form) {
        // Fixed price item selection
        form.find('.fixed-price-items').on('change', function() {
            updateHargaPerGram(form);
        });
        
        // Auto-fill harga when kode is entered
        form.find('.kodeEmas').on('input', function() {
            // Clear fixed price selection if typing in kode field
            form.find('.fixed-price-items').val('');
            updateHargaPerGram(form);
        });
        
        // Toggle detail button
        form.find('.toggle-detail-btn').off('click').on('click', function() {
            const detailContainer = form.next('.detailPenjualan');
            const isVisible = detailContainer.hasClass('show');
            
            if (isVisible) {
                detailContainer.removeClass('show');
                $(this).html('<i class="fas fa-eye me-1"></i> Tampilkan Detail');
            } else {
                detailContainer.addClass('show');
                $(this).html('<i class="fas fa-eye-slash me-1"></i> Sembunyikan Detail');
            }
        });
        
        // Hitung button
        form.find('.hitungBtn').off('click').on('click', function() {
            hitungHarga(form);
        });
    }
    
    // Initialize form elements for kode
    function initializeFormElementsKode(form) {
        // Kode item selection
        form.find('.kode-items').on('change', function() {
            updateHargaPerGramKode(form);
        });
        
        // Auto-fill harga when kode is entered
        form.find('.kodePersen').on('input', function() {
            // Clear selected kode if typing in kode field
            form.find('.kode-items').val('');
            updateHargaPerGramKode(form);
        });
        
        // Toggle detail button
        form.find('.toggle-detail-btn').off('click').on('click', function() {
            const detailContainer = form.next('.detailPenjualan');
            const isVisible = detailContainer.hasClass('show');
            
            if (isVisible) {
                detailContainer.removeClass('show');
                $(this).html('<i class="fas fa-eye me-1"></i> Tampilkan Detail');
            } else {
                detailContainer.addClass('show');
                $(this).html('<i class="fas fa-eye-slash me-1"></i> Sembunyikan Detail');
            }
        });
        
        // Hitung button
        form.find('.hitungBtnKode').off('click').on('click', function() {
            hitungHargaKodeForm(form);
        });
    }
    
    // Initialize first form
    initializeFormElements($('#formEmas'));
    initializeFormElementsKode($('#formKode'));
    
    // COKIM button
    $('#cokimBtn').on('click', function() {
        const newCokim = prompt("Masukkan nilai COKIM saat ini:", cokim.toLocaleString('id-ID'));
        if (newCokim !== null) {
            // Remove non-numeric characters and parse
            const parsedCokim = parseInt(newCokim.replace(/\D/g, ''));
            if (!isNaN(parsedCokim) && parsedCokim > 0) {
                cokim = parsedCokim;
                alert(`Nilai COKIM berhasil diupdate menjadi Rp. ${cokim.toLocaleString('id-ID')}`);
                
                // Update all forms that have kode entered (except fixed price items)
                $('.penjualan-form').each(function() {
                    const form = $(this);
                    if (form.find('.kodeEmas').val() && !form.find('.fixed-price-items').val()) {
                        updateHargaPerGram(form);
                        if (form.data('hargaFix') !== undefined) {
                            hitungHarga(form);
                        }
                    }
                    if (form.find('.kodePersen').val()) {
                        updateHargaPerGramKode(form);
                        if (form.data('hargaFix') !== undefined) {
                            hitungHargaKodeForm(form);
                        }
                    }
                });
            } else {
                alert("Masukkan nilai COKIM yang valid!");
            }
        }
    });
    
    // Tambah barang button
    $('.tambahBarangBtn').on('click', function() {
        const formClone = $('#formEmas').clone();
        formClone.find('input, select').val('');
        formClone.find('.discount').val('0');
        formClone.find('.fixed-price-items').val('');
        formClone.find('.kodeEmas').prop('disabled', false);
        formClone.removeAttr('id');
        formClone.find('.delete-btn-container').css('display', 'block');
        formClone.find('.detailPenjualan').remove();
        $('#formContainer').append(formClone);
        
        // Initialize the new form
        initializeFormElements(formClone);
        
        // Scroll to the new form
        $('html, body').animate({
            scrollTop: formClone.offset().top - 100
        }, 500);
    });
    
    // Tambah barang button kode
    $('.tambahBarangBtnKode').on('click', function() {
        const formClone = $('#formKode').clone();
        formClone.find('input, select').val('');
        formClone.find('.discountKode').val('0');
        formClone.find('.kode-items').val('');
        formClone.removeAttr('id');
        formClone.find('.delete-btn-container').css('display', 'block');
        formClone.find('.detailPenjualan').remove();
        $('#formContainerKode').append(formClone);
        
        // Initialize the new form
        initializeFormElementsKode(formClone);
        
        // Scroll to the new form
        $('html, body').animate({
            scrollTop: formClone.offset().top - 100
        }, 500);
    });
    
    // Clear button
    $(document).on('click', '.clearBtn', function() {
        const form = $(this).closest('.penjualan-form');
        const previousHargaFix = form.data('hargaFix') || 0;
        totalPenjualan -= previousHargaFix;
        updateTotalPenjualan(totalPenjualan);
        
        form.removeData('hargaFix');
        form.next('.detailPenjualan').remove();
        form.find('.fixed-price-items').val('');
        form.find('.kodeEmas').prop('disabled', false);
        
        // Reset toggle button
        form.find('.toggle-detail-btn').html('<i class="fas fa-eye me-1"></i> Tampilkan Detail');
    });
    
    // Clear button kode
    $(document).on('click', '.clearBtnKode', function() {
        const form = $(this).closest('.penjualan-form');
        const previousHargaFix = form.data('hargaFix') || 0;
        totalPenjualanKode -= previousHargaFix;
        updateTotalPenjualanKode(totalPenjualanKode);
        
        form.removeData('hargaFix');
        form.next('.detailPenjualan').remove();
        form.find('.kode-items').val('');
        
        // Reset toggle button
        form.find('.toggle-detail-btn').html('<i class="fas fa-eye me-1"></i> Tampilkan Detail');
    });
    
    // Delete button
    $(document).on('click', '.deleteBtn', function() {
        const form = $(this).closest('.penjualan-form');
        const previousHargaFix = form.data('hargaFix') || 0;
        totalPenjualan -= previousHargaFix;
        updateTotalPenjualan(totalPenjualan);
        
        form.next('.detailPenjualan').remove();
        form.remove();
    });
    
    // Delete button kode
    $(document).on('click', '.deleteBtnKode', function() {
        const form = $(this).closest('.penjualan-form');
        const previousHargaFix = form.data('hargaFix') || 0;
        totalPenjualanKode -= previousHargaFix;
        updateTotalPenjualanKode(totalPenjualanKode);
        
        form.next('.detailPenjualan').remove();
        form.remove();
    });
    
        // Floating buttons scroll effect
    $(window).scroll(function() {
        if ($(window).scrollTop() > 100) {
            $('.floating-buttons-container').css({
                'bottom': '15px',
                'right': '15px',
                'transition': 'all 0.3s ease'
            });
        } else {
            $('.floating-buttons-container').css({
                'bottom': '15px',
                'right': '15px',
                'transition': 'all 0.3s ease'
            });
        }
    });
    
    // Harga button functionality
$('#hargaBtn').on('click', function() {
    $('#hargaModal').modal('show');
    loadHargaData();
});

function loadHargaData() {
    $('#hargaContainer').html('');
    $('.modal-body .spinner').show();
    
    $.ajax({
        url: 'harga.json', // Make sure this path is correct
        dataType: 'json',
        success: function(data) {
            $('.modal-body .spinner').hide();
            displayHargaData(data);
        },
        error: function() {
            $('.modal-body .spinner').hide();
            $('#hargaContainer').html('<div class="alert alert-danger">Gagal memuat data harga. Silakan coba lagi.</div>');
        }
    });
}

function displayHargaData(data) {
    let html = '';
    
    // Process emas data
    html += '<div class="harga-category">Emas</div>';
    html += '<table class="harga-table"><thead><tr><th>Item</th><th>Harga Jual</th></tr></thead><tbody>';
    data.emas.forEach(item => {
        if (item.sellPrice > 0) {
            html += `<tr><td>${item.code}</td><td>Rp. ${item.sellPrice.toLocaleString('id-ID')}</td></tr>`;
        }
    });
    html += '</tbody></table>';
    
    // Process antam data
    html += '<div class="harga-category">Antam</div>';
    html += '<table class="harga-table"><thead><tr><th>Item</th><th>Harga Jual</th></tr></thead><tbody>';
    data.antam.forEach(item => {
        if (item.sellPrice > 0) {
            html += `<tr><td>${item.code}</td><td>Rp. ${item.sellPrice.toLocaleString('id-ID')}</td></tr>`;
        }
    });
    html += '</tbody></table>';
    
    // Process archi data
    html += '<div class="harga-category">Archi</div>';
    html += '<table class="harga-table"><thead><tr><th>Item</th><th>Harga Jual</th></tr></thead><tbody>';
    data.archi.forEach(item => {
        if (item.sellPrice > 0) {
            html += `<tr><td>${item.code}</td><td>Rp. ${item.sellPrice.toLocaleString('id-ID')}</td></tr>`;
        }
    });
    html += '</tbody></table>';
    
    $('#hargaContainer').html(html);
}

// Refresh harga when modal is shown
$('#hargaModal').on('shown.bs.modal', function() {
    loadHargaData();
});
});
    </script>
</body>
</html>
